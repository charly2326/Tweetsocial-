<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Tweet🐔</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>


    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">

<style>


/* Estilos del contenedor de perfil */
#profileContainer {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ddd; /* Color para visualizar */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    display: none;
}

#profileContainer img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Estilos para el modal */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
}

.hidden {
    display: none !important;
}

.scale-100 {
    transform: scale(1);
    opacity: 1;
}

.scale-95 {
    transform: scale(0.95);
    opacity: 0;
}

/* Estilos para la transición del sidebar */
.sidebar-collapsed .sidebar-text {
    opacity: 0;
    width: 0;
    margin-left: 0;
    margin-right: 0;
    position: absolute;
}

.sidebar-collapsed .sidebar-icon {
    font-size: 1.5rem;
    margin: 0 auto;
}

.sidebar-collapsed {
    width: 5rem !important;
}

.sidebar-collapsed .sidebar-content {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
}

.sidebar-collapsed #mainContent {
    margin-left: 5rem;
}




/* Modo oscuro mejorado */
/* ----- Textos y Botones Críticos ----- */
body.dark-mode {
    background-color: #0f0f0f;  /* Fondo más claro que negro puro */
}







/* Títulos y textos principales */
body.dark-mode .post-title,
body.dark-mode .username,
body.dark-mode .post-content {
    color: #f0f0f0 !important;  /* Blanco roto */
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); /* Mejor contraste */
}

/* Botones de interacción (Comentarios, Me gusta, etc.) */
body.dark-mode .interaction-buttons {
    background-color: #1a1a1a;
    border-top: 1px solid #333;
    padding: 12px 0;
}

body.dark-mode .interaction-btn {
    color: #bbbbbb !important;  /* Gris claro */
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 20px;
    margin: 0 5px;
    transition: all 0.2s;
}

/* Efecto hover para destacar */
body.dark-mode .interaction-btn:hover {
    background-color: #333 !important;
    color: #fff !important;
}

/* Botón "Publicar" (destacado) */
body.dark-mode .publish-btn {
    background: linear-gradient(135deg, #8a2be2, #5f27cd) !important;
    color: white !important;
    border: none;
    font-size: 1.1em;
    box-shadow: 0 2px 10px rgba(139, 0, 255, 0.3);
}

/* Stats numéricos (78990, 72650) */
body.dark-mode .stats-value {
    color: #4cc9f0 !important;  /* Azul neón */
    font-size: 1.2em;
    font-weight: bold;
}























</style>


</head>


<body class="bg-gray-50 dark:bg-gray-900">
    <div class="flex min-h-screen">
        <!-- Sidebar moderno con glassmorphism -->
        <aside id="sidebar" class="bg-white/80 dark:bg-gray-800/90 backdrop-blur-lg border-r border-gray-200 dark:border-gray-700 sticky top-0 h-screen overflow-y-auto transition-all duration-300 w-72">
            <!-- Botón para contraer/expandir mejorado -->
            <button id="toggleSidebar" class="absolute -right-3 top-5 bg-white dark:bg-gray-700 rounded-full shadow-lg p-1.5 z-10 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>

            <!-- Contenido del sidebar -->
            <div class="p-6 sidebar-content">
                <!-- Logo/Brand premium -->
                <div class="mb-10 flex items-center transition-all duration-300 group">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center shadow-md mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent whitespace-nowrap sidebar-text">SocialApp</h1>
                </div>

                <!-- Contenedor de Login / Perfil mejorado -->
                <div id="authContainer" class="mb-8">
                    <button id="loginBtn" class="w-full flex items-center justify-center bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-2.5 px-4 rounded-lg shadow-md transition-all duration-300 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span class="sidebar-text ml-3 font-medium">Iniciar sesión</span>
                    </button>

                    <!-- Contenedor del perfil premium -->
                    <div id="profileContainerSidebar" class="hidden group flex items-center p-3 rounded-xl bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 cursor-pointer">
                        <div class="relative">
                            <img id="profilePicSidebar" src="https://via.placeholder.com/50" alt="Perfil" class="w-11 h-11 rounded-xl object-cover border-2 border-white dark:border-gray-700">
                            <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white dark:border-gray-700"></div>
                        </div>
                        <div class="ml-3">
                            <span id="usernameSidebar" class="font-semibold text-gray-800 dark:text-white whitespace-nowrap sidebar-text block">Usuario</span>
                        </div>
                    </div>
                </div>

                <!-- Menú de navegación premium -->
                <nav class="mb-8">
                    <ul class="space-y-1.5">
                        <li>
                            <a href="#" class="flex items-center p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 group">
                                <div class="sidebar-icon w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:bg-blue-200 dark:group-hover:bg-blue-900/50 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg>
                                </div>
                                <span class="sidebar-text ml-3 text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400">Pedidos</span>
                                <span class="ml-auto bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-xs px-2 py-1 rounded-full font-medium">5</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 group">
                                <div class="sidebar-icon w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600 dark:text-red-400 group-hover:bg-red-200 dark:group-hover:bg-red-900/50 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                    </svg>
                                </div>
                                <span class="sidebar-text ml-3 text-gray-700 dark:text-gray-300 group-hover:text-red-600 dark:group-hover:text-red-400">Notificaciones</span>
                                <span class="ml-auto bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs px-2 py-1 rounded-full font-medium">3</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="openSimpleMessagesModal()" class="flex items-center p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 group">
                                <div class="sidebar-icon w-8 h-8 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400 group-hover:bg-green-200 dark:group-hover:bg-green-900/50 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                </div>
                                <span class="sidebar-text ml-3 text-gray-700 dark:text-gray-300 group-hover:text-green-600 dark:group-hover:text-green-400">Chats</span>
                            </a>
                        </li>
                        <li>
                            <button id="openEditProfileFromModal" class="w-full flex items-center p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-all duration-200 group">
                                <div class="sidebar-icon w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:bg-purple-200 dark:group-hover:bg-purple-900/50 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <span class="sidebar-text ml-3 text-gray-700 dark:text-gray-300 group-hover:text-purple-600 dark:group-hover:text-purple-400">Editar</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- Botones -->
                <button id="crearPublicacionBtn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg mt-4 transition duration-200 shadow-md">
                    <span class="sidebar-icon">+</span>
                    <span class="sidebar-text ml-2">Crear</span>
                </button>
                <button id="venderBtn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-lg mt-2 transition duration-200 shadow-md">
                    <span class="sidebar-icon">🛒</span>
                    <span class="sidebar-text ml-2">Vender</span>
                </button>
            </div>
        </aside>















<!-- SIDEBAR MÓVIL (Bottom navbar) -->
<nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
  <ul class="flex justify-around py-2">

    <!-- Editar (⚙️ → Icono SVG) -->
    <li>
      <button id="mobileEditBtn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span class="text-xs mt-1">Editar</span>
      </button>
    </li>

    <!-- Crear (➕ → Icono SVG) -->
    <li>
      <button id="mobileCrearBtn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        <span class="text-xs mt-1">Crear</span>
      </button>
    </li>

    <!-- Vender (🛒 → Icono SVG) -->
    <li>
      <button id="mobileVenderBtn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <span class="text-xs mt-1">Vender</span>
      </button>
    </li>

    <!-- Chats (💬 → Icono SVG) -->
    <li>
      <button onclick="openSimpleMessagesModal()" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <span class="text-xs mt-1">Chats</span>
      </button>
    </li>

   <!-- Perfil - Solo ícono circular -->
<li>
  <button id="mobilePerfilBtn" class="relative flex items-center justify-center text-gray-600 hover:text-blue-500 dark:hover:text-blue-400 transition-colors">
    <!-- Contenedor de imagen de perfil ampliado -->
    <div class="relative w-10 h-10"> <!-- Tamaño aumentado a w-10 h-10 -->
      <!-- Imagen de perfil (oculta por defecto) -->
      <img id="mobileProfilePic" src="" alt="Perfil" class="hidden w-full h-full rounded-full object-cover border-2 border-white dark:border-gray-700 shadow-sm">
      <!-- Ícono SVG por defecto -->
      <svg id="mobileProfileIcon" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0 h-full w-full p-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
    </div>
  </button>
</li>

  </ul>
</nav>












        




<main class="flex-1 p-6 max-w-2xl mx-auto">
  <!-- Creador de publicaciones -->
  <div class="bg-sky-50 p-5 rounded-xl shadow-lg border-2 border-blue-300 mb-6">
    <textarea id="postInput" placeholder="¿Qué piensas, nakama? (´• ω •`)ﾉ"
      rows="3"
      class="w-full p-3 border-2 border-blue-400 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white text-gray-800 placeholder-blue-400 font-sans"></textarea>

    <div class="flex items-center justify-between mb-3">
      <div>
        <label for="postImageInput" class="cursor-pointer text-blue-600 hover:text-blue-800 transition flex items-center">
          <!-- Ícono de cámara estilo anime -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15a2.25 2.25 0 002.25-2.25V9.574c0-1.067-.749-1.994-1.802-2.169a41.76 41.76 0 00-1.134-.175 2.31 2.31 0 01-1.641-1.055l-.986-1.647A2.25 2.25 0 0015.868 4.5H8.132a2.25 2.25 0 00-1.924 1.028l-.986 1.647z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" />
          </svg>
          <span class="font-medium">Agregar archivo</span>
        </label>
        <input id="postImageInput" type="file" multiple accept="image/*,video/*,audio/*,.zip,.rar,.pdf,.doc,.docx" class="hidden">
      </div>
      <span id="fileInfo" class="text-sm text-blue-600 truncate max-w-xs font-medium"></span>
    </div>

    <!-- Contenedor de previsualización (solo imagen principal o texto si es otro tipo) -->
    <div id="mediaPreviewContainer" class="mb-3 hidden">
      <div class="relative rounded-lg overflow-hidden border-2 border-blue-400">
        <img id="mediaPreview" src="#" alt="Previsualización" class="w-full hidden">
        <ul id="fileList" class="list-disc list-inside text-blue-700 p-2 text-sm"></ul>

        <!-- Overlay de carga con cara anime 3D -->
        <div id="loadingOverlay" class="absolute inset-0 bg-blue-600 bg-opacity-80 flex flex-col items-center justify-center hidden">
          <span class="text-4xl mb-2 animate-bounce">(＾• ω •＾)</span>
          <span class="text-white font-bold">Subiendo... ٩(◕‿◕｡)۶</span>
        </div>
      </div>
    </div>

    <button id="publishBtn" disabled
      class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition-all duration-300 shadow hover:shadow-md disabled:opacity-50 font-bold flex items-center justify-center">
      <span class="mr-2">Publicar</span>
      <span class="text-xl">(ᗒᗨᗕ)</span>
    </button>
  </div>

  <!-- Contenedor de publicaciones -->
  <div id="postsContainer" class="space-y-6"></div>
</main>












<!-- Modal de Login -->
<div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-96 relative">

        <h2 class="text-2xl font-extrabold text-gray-800 mb-3">Bienvenido</h2>
        <p class="text-sm text-gray-500 mb-5">Elige una opción para continuar</p>

        <!-- Botón para iniciar sesión como vendedor -->
        <button id="sellerLoginBtn" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 transition text-white p-2.5 rounded-lg mb-3 shadow">
            <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="w-6 h-6">
            <span class="font-medium">Continuar para vendedores</span>
        </button>

        <!-- Botón para iniciar sesión con Google -->
        <button id="googleLoginBtn" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 transition text-white p-2.5 rounded-lg shadow">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            <span class="font-medium">Continuar con Google</span>
        </button>

        <!-- Pie con Términos y Condiciones -->
        <div class="px-6 py-3 bg-gray-50 text-center border-t border-gray-200 rounded-b-lg mt-5">
            <p class="text-xs text-gray-400">Al continuar aceptas nuestros <a href="#" class="text-blue-600 hover:underline">Términos y Condiciones</a></p>
        </div>

        <!-- Botón para cerrar el modal -->
        <button id="closeModal" class="absolute top-2 right-2 text-gray-500 text-2xl hover:text-gray-700 transition">&times;</button>

    </div>
</div>

<!-- Contenedor del perfil -->
<div id="profileContainer" class="hidden flex items-center space-x-2 cursor-pointer">
    <img id="profilePic" src="https://via.placeholder.com/40" alt="Perfil" class="w-10 h-10 rounded-full">
    <span id="profileName" class="font-semibold"></span>
</div>













    






<!-- MODAL EDITAR PERFIL - ESTILO MODERNO GEN Z CON SVG MEJORADOS -->
<div id="editProfileModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-md transition-all duration-300">
  <div class="bg-white dark:bg-gray-900 p-6 sm:p-8 rounded-2xl shadow-2xl w-11/12 max-w-md relative border border-gray-200 dark:border-gray-800 animate-fade-in">
    
    <!-- Botón cerrar - Icono moderno -->
    <button id="closeEditProfileModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 dark:hover:text-white transition duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none">
        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 12l4.95 4.95m-9.9-9.9L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-opacity="0.5"/>
      </svg>
    </button>

    <!-- Título -->
    <h2 class="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-white">Editar perfil</h2>

    <!-- Imagen de Perfil - Icono de cámara mejorado -->
    <div class="relative mx-auto w-24 h-24 mb-6 group">
      <img id="editProfilePic" src="https://i.pinimg.com/564x/16/f7/52/16f752812b45c61e5b51e24c69d998dc.jpg" class="w-full h-full rounded-full object-cover border-4 border-white dark:border-gray-700 shadow-lg transition duration-300 group-hover:scale-105">
      <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full opacity-0 group-hover:opacity-100 flex items-center justify-center transition duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none">
          <path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10z" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8 12a4 4 0 108 0 4 4 0 00-8 0z" stroke="currentColor" stroke-width="1.5"/>
          <path d="M17 7.5V5.8c0-.995 0-1.493-.191-1.86a1.8 1.8 0 00-.749-.75C15.693 3 15.195 3 14.2 3H9.8c-.995 0-1.493 0-1.86.19a1.8 1.8 0 00-.75.75C7 4.307 7 4.805 7 5.8v1.7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <!-- Inputs -->
    <div class="space-y-5">
      <div>
        <label for="editProfileName" class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Nombre</label>
        <input id="editProfileName" type="text" class="w-full px-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-white transition" placeholder="Tu nombre">
      </div>

      <div>
        <label for="editProfileUsername" class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Usuario</label>
        <input id="editProfileUsername" type="text" class="w-full px-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-white transition" placeholder="@usuario">
      </div>

      <div>
        <label for="editProfileBio" class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Biografía</label>
        <textarea id="editProfileBio" rows="3" class="w-full px-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-800 dark:text-white transition" placeholder="Cuéntanos algo sobre ti..."></textarea>
      </div>
    </div>

    <!-- Botones con iconos mejorados -->
    <div class="mt-8 space-y-3">

      <!-- Guardar cambios - Checkmark moderno -->
      <button id="saveProfileBtn" class="w-full py-2 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold rounded-xl shadow transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" stroke="currentColor" stroke-width="1.8" stroke-opacity="0.7"/>
        </svg>
        Guardar cambios
      </button>

      <!-- Convertirse en vendedor - Icono de tienda moderno -->
      <button id="switchToSellerBtn" class="w-full py-2 px-4 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded-xl shadow transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M3 10h18v9a2 2 0 01-2 2H5a2 2 0 01-2-2v-9z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M3 10l1.575-6.299A1 1 0 015.561 3h12.878a1 1 0 01.986 1.701L21 10" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
          <path d="M9 14v3M15 14v3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        </svg>
        Convertirme en vendedor
      </button>

      <!-- Cambiar tema - Icono de sol/luna más detallado -->
      <button id="theme-toggle" class="w-full py-2 px-4 bg-gray-700 hover:bg-gray-800 text-white font-medium rounded-xl transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M12 16a4 4 0 100-8 4 4 0 000 8z" stroke="currentColor" stroke-width="1.5"/>
          <path d="M12 3V2M12 22v-1M18.36 5.64l.71-.71M4.93 19.07l.71-.71M21 12h-1M4 12H3M18.36 18.36l.71.71M4.93 4.93l.71.71" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        Cambiar tema
      </button>

      <!-- Cerrar sesión - Icono de salida moderno -->
      <button id="logoutBtn" class="w-full py-2 px-4 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl font-medium transition flex items-center justify-center gap-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
          <path d="M15 16.5V19a2 2 0 01-2 2H6a2 2 0 01-2-2V5a2 2 0 012-2h7a2 2 0 012 2v3.063" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          <path d="M10 12h10m0 0l-3-3m3 3l-3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Cerrar sesión
      </button>
    </div>
  </div>
</div>




































<!-- MODAL DEL PERFIL - VERSIÓN MEJORADA -->
<div id="profileModal" class="modal hidden fixed inset-0 flex items-center justify-center z-50">
    <!-- Fondo oscuro con efecto glassmorphism mejorado -->
    <div id="modalOverlay" class="modal-overlay fixed inset-0 bg-black/60 backdrop-blur-lg"></div>

    <!-- Contenido del modal - Diseño moderno -->
    <div id="modalContent" class="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-2xl text-center w-full max-w-md relative transform scale-95 opacity-0 transition-all duration-300 ease-in-out border border-gray-100 dark:border-gray-700">
        <!-- Botón de cerrar con mejor feedback -->
        <button id="closeProfileModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-2xl transition-colors duration-200 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
            &times;
        </button>

        <!-- Foto de perfil con hover effect -->
        <div class="relative group mx-auto w-28 h-28 mb-4">
            <label for="profilePicInput" class="cursor-pointer block">
                <img id="profilePicModal" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover border-4 border-white dark:border-gray-800 shadow-lg group-hover:opacity-80 transition-opacity">
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="bg-black/50 text-white text-xs font-medium px-2 py-1 rounded-full">Cambiar</span>
                </div>
            </label>
            <input type="file" id="profilePicInput" accept="image/*" class="hidden">
        </div>
        
        <button id="saveProfilePicBtn" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-full shadow-lg hover:shadow-xl transition-all mt-2 hidden text-sm font-medium">
            Guardar Cambios
        </button>

        <!-- Información del usuario con mejor jerarquía visual -->
        <div class="mb-4">
            <h2 id="modalProfileName" class="text-2xl font-bold text-gray-900 dark:text-white">Owen</h2>
            <p id="modalProfileUsername" class="text-indigo-600 dark:text-indigo-400 font-medium">@charly</p>
            <p id="modalProfileBio" class="text-gray-600 dark:text-gray-300 text-sm mt-2 max-w-xs mx-auto">Esta es la biografía del usuario. Puede ser más larga y mostrar intereses, pasatiempos o lo que quiera compartir.</p>
        </div>

        <!-- Botones de acción con micro-interacciones -->
        <div class="flex justify-center gap-3 mb-6">
            <button id="openEditProfileFromModal" class="hidden bg-white dark:bg-gray-800 text-gray-800 dark:text-white px-5 py-2 rounded-full shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-700 text-sm font-medium hover:bg-gray-50 dark:hover:bg-gray-700">
                Editar perfil
            </button>

            <button id="followBtn" class="hidden bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-5 py-2 rounded-full shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-indigo-700 transition-all text-sm font-medium">
                Seguir
            </button>
        </div>

        <!-- Stats con diseño más atractivo -->
        <div class="flex justify-around text-gray-700 dark:text-gray-300 text-sm mb-6">
            <div class="flex flex-col items-center">
                <span id="profilePostCount" class="font-bold text-lg text-gray-900 dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">Publicaciones</span>
            </div>
            <div class="flex flex-col items-center">
                <span id="profileFollowingCount" class="font-bold text-lg text-gray-900 dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">Siguiendo</span>
            </div>
            <div class="flex flex-col items-center">
                <span id="profileFollowersCount" class="font-bold text-lg text-gray-900 dark:text-white">0</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">Seguidores</span>
            </div>
        </div>

        <!-- Timeline con mejor diseño -->
        <div class="border-t border-gray-200 dark:border-gray-800 pt-4">
            <h3 class="font-bold text-gray-800 dark:text-white mb-3 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Timeline
            </h3>
            <div class="space-y-2">
                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg shadow-sm hover:shadow transition-all cursor-pointer">
                    <p class="text-sm font-medium text-gray-800 dark:text-white">Primer Publicación</p>
                    <p class="text-xs text-gray-500 mt-1">Hace 2 días</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg shadow-sm hover:shadow transition-all cursor-pointer">
                    <p class="text-sm font-medium text-gray-800 dark:text-white">Segunda Publicación</p>
                    <p class="text-xs text-gray-500 mt-1">Hace 1 semana</p>
                </div>
            </div>
        </div>
    </div>
</div>





    <!-- MODAL PARA VENDEDORES -->
<div id="sellerProfileModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div id="sellerModalContent" class="bg-white p-6 rounded-lg shadow-lg text-center w-[500px] relative">

    <!-- Botón de cerrar -->
    <button id="closeSellerModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">
      &times;
    </button>

    <!-- Imagen de perfil -->
    <img id="sellerProfilePic" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full mx-auto mb-2" />

    <h2 id="sellerName" class="text-xl font-bold">Nombre del Vendedor</h2>
    <p id="sellerUsername" class="text-gray-600">@usuario</p>
    <p id="sellerBio" class="text-gray-500 text-sm mb-4">Biografía del vendedor.</p>

    <!-- Botones funcionales -->
    <button id="openOrdersModal" class="bg-green-500 text-white px-4 py-2 rounded mb-2 w-full">📦 Ver pedidos</button>
    <button id="openEarningsModal" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2 w-full">💰 Gestionar ingresos</button>
    <button id="editSellerProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2 w-full">✏ Editar perfil</button>

    <!-- Estadísticas -->
    <div class="flex justify-around text-gray-700 text-sm mt-3">
      <span><b id="sellerTweets">0</b> Publicaciones</span>
      <span><b id="sellerFollowing">0</b> Siguiendo</span>
      <span><b id="sellerFollowers">0</b> Seguidores</span>
    </div>

    <!-- Historial -->
    <h3 class="mt-4 font-bold text-gray-800">Historial de Ventas</h3>
    <div class="bg-gray-100 p-2 rounded mt-2">Último Pedido</div>
    <div class="bg-gray-100 p-2 rounded mt-2">Producto Más Vendido</div>
  </div>
</div>


<!-- MODAL: Ver Pedidos -->
<div id="ordersModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeOrdersModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">📦 Tus Pedidos</h2>
    <div class="text-sm text-gray-600">
      <p>Aquí aparecerán los pedidos realizados por tus compradores.</p>
    </div>
  </div>
</div>

<!-- MODAL: Gestionar Ingresos -->
<div id="earningsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeEarningsModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">💰 Gestionar Ingresos</h2>
    <div class="text-sm text-gray-600">
      <p>Resumen de tus ingresos y opciones para retirar fondos.</p>
    </div>
  </div>
</div>


<!-- Modal de imagen de perfil -->
<div id="profilePicPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="w-40 h-40 rounded-full overflow-hidden border-4 border-white shadow-lg">
    <img id="previewProfilePic" src="" class="w-full h-full object-cover" />
  </div>
</div>




















<!-- Modal de Mensajes Simple - Versión Corregida y Mejorada -->
<div id="simpleMessagesModal" class="fixed inset-0 z-50 hidden">
  <!-- Fondo oscuro para móviles -->
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm md:bg-transparent md:backdrop-blur-none" onclick="closeSimpleMessagesModal()"></div>
  
  <!-- Contenedor principal - Responsivo -->
  <div class="absolute md:relative h-full md:h-auto bg-white dark:bg-gray-800 rounded-t-xl md:rounded-xl shadow-xl md:shadow-lg w-full max-w-md md:max-w-sm mx-auto md:mx-4 mt-auto md:mt-0 bottom-0 md:bottom-auto md:right-0 md:top-16 border border-gray-200 dark:border-gray-700 transform transition-transform duration-300 ease-out">
    <!-- Encabezado -->
    <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
      <h2 class="text-lg font-bold text-gray-800 dark:text-white flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        Mensajes
      </h2>
      <button onclick="closeSimpleMessagesModal()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 text-xl p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
        &times;
      </button>
    </div>

    <!-- Lista de contactos -->
    <div id="simpleFollowingList" class="p-4 space-y-3 max-h-[calc(100vh-120px)] md:max-h-[70vh] overflow-y-auto">
      <!-- Ejemplo de contacto - Se cargarán dinámicamente -->
      <div class="contact-item flex items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transition">
        <img src="https://randomuser.me/api/portraits/women/44.jpg" class="w-10 h-10 rounded-full object-cover border-2 border-white dark:border-gray-600 shadow-sm">
        <div class="ml-3 flex-1 min-w-0">
          <h3 class="font-medium text-gray-900 dark:text-white truncate">María González</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 truncate">Hola! ¿Cómo estás?</p>
        </div>
        <span class="text-xs text-gray-400 dark:text-gray-500">12 min</span>
      </div>
    </div>

    <!-- Área de chat (hidden inicialmente) -->
    <div id="simpleChatBox" class="hidden absolute inset-0 bg-white dark:bg-gray-800 flex flex-col">
      <!-- Encabezado del chat -->
      <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
        <button id="backToContacts" class="mr-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <div class="flex-1 text-center">
          <div class="text-sm font-medium text-gray-700 dark:text-gray-300" id="chatWithName">Hablando con: <span class="font-semibold text-gray-900 dark:text-white">Carlos Pérez</span></div>
        </div>
        <div class="w-6"></div> <!-- Espaciador para alinear el título al centro -->
      </div>

      <!-- Mensajes -->
      <div id="simpleChatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 dark:bg-gray-700/30">
        <!-- Mensaje recibido -->
        <div class="flex">
          <div class="max-w-xs px-3 py-2 rounded-lg rounded-tl-none bg-gray-200 dark:bg-gray-600">
            <p class="text-gray-800 dark:text-gray-200">Hola! ¿Cómo estás?</p>
            <p class="text-right text-xs text-gray-500 dark:text-gray-400 mt-1">10:24 AM</p>
          </div>
        </div>
        
        <!-- Mensaje enviado -->
        <div class="flex justify-end">
          <div class="max-w-xs px-3 py-2 rounded-lg rounded-tr-none bg-indigo-500 text-white">
            <p>Todo bien, gracias!</p>
            <p class="text-right text-xs text-indigo-200 mt-1">10:25 AM</p>
          </div>
        </div>
      </div>

      <!-- Input de mensaje -->
      <div class="sticky bottom-0 p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
        <div class="flex gap-2">
          <input type="text" id="simpleMessageInput" class="flex-1 border border-gray-300 dark:border-gray-600 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Escribe un mensaje...">
          <button onclick="sendSimpleMessage()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-full text-sm transition flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>














                                                                                                            


                                                                                                            


<!-- Modal para publicaciones de vendedor - Versión corregida -->
<div id="sellerPostModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
  <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-xl shadow-xl relative overflow-hidden">
    <!-- Cabecera del modal -->
    <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
      <h2 class="text-xl font-semibold text-gray-800 dark:text-white text-center flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-600 dark:text-blue-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 2a4 4 0 00-4 4v1H5a1 1 0 00-.994.89l-1 9A1 1 0 004 18h12a1 1 0 00.994-1.11l-1-9A1 1 0 0015 7h-1V6a4 4 0 00-4-4zm2 5V6a2 2 0 10-4 0v1h4zm-6 3a1 1 0 112 0 1 1 0 01-2 0zm7-1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
        </svg>
        Publicar producto
      </h2>
    </div>

    <!-- Contenido del formulario -->
    <div class="p-6 space-y-4">
      <!-- Grupo de campos -->
      <div class="space-y-1">
        <label for="productTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título del producto</label>
        <input
          id="productTitle"
          type="text"
          placeholder="Ej: Camiseta de algodón 100%"
          class="block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
          required
        >
      </div>

      <div class="space-y-1">
        <label for="productDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripción</label>
        <textarea
          id="productDescription"
          rows="3"
          placeholder="Describa las características del producto..."
          class="block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
          required
        ></textarea>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="space-y-1">
          <label for="productPrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio ($)</label>
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="text-gray-500 dark:text-gray-400 sm:text-sm">$</span>
            </div>
            <input
              id="productPrice"
              type="number"
              step="0.01"
              min="0"
              placeholder="0.00"
              class="block w-full pl-7 pr-12 rounded-lg border-gray-300 dark:border-gray-600 focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
              required
            >
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <span class="text-gray-500 dark:text-gray-400 sm:text-sm">USD</span>
            </div>
          </div>
        </div>

        <!-- Código de país y número de teléfono -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Código de país -->
          <div class="space-y-1">
            <label for="codigoPais" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Código de país</label>
            <input
              id="codigoPais"
              type="text"
              placeholder="Ej: +57"
              class="block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
              required
            >
          </div>

          <!-- Número de teléfono -->
          <div class="space-y-1">
            <label for="productWhatsapp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Número de WhatsApp</label>
            <input
              id="productWhatsapp"
              type="tel"
              placeholder="Ej: 3001234567"
              class="block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
              required
            >
          </div>
        </div>
      </div>

      <div class="space-y-1">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Imagen/Vídeo</label>
        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg">
          <div class="space-y-1 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
              <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="flex text-sm text-gray-600 dark:text-gray-400">
              <label for="productImage" class="relative cursor-pointer bg-white dark:bg-gray-800 rounded-md font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500 dark:hover:text-blue-300 focus-within:outline-none">
                <span>Subir archivo</span>
                <input id="productImage" type="file" accept="image/*,video/*" class="sr-only" multiple>
              </label>
              <p class="pl-1">o arrastrar aquí</p>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400">PNG, JPG, MP4 hasta 10MB</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pie del modal -->
    <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 flex justify-between items-center border-t border-gray-200 dark:border-gray-600">
      <button
        onclick="closeSellerPostModal()"
        class="text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-4 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
      >
        Cancelar
      </button>
      <button
        id="publicarProductoBtn"
        onclick="publicarProducto()"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
        </svg>
        Publicar producto
      </button>
    </div>
  </div>
</div>












<div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden z-50">
  <button onclick="closeMediaModal()" class="absolute top-4 right-4 text-white text-2xl">&times;</button>
  <div id="mediaContainer" class="max-w-full max-h-full p-4">
    <!-- Aquí aparecerá la imagen o video -->
  </div>
</div>























<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

  import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  getDocs,
  addDoc,
  deleteDoc,
  serverTimestamp,
  query,
  where,
  orderBy,
  onSnapshot,
  collection,
  updateDoc,
  increment // ✅ <- Agregado aquí
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

  // 🔥 Configuración nueva de Firebase (tweet-1de1a)
  const firebaseConfig = {
    apiKey: "AIzaSyC8pD3uDtpasEzcn8uDHqzOnLPYU9hRttM",
    authDomain: "tweet-1de1a.firebaseapp.com",
    projectId: "tweet-1de1a",
    storageBucket: "tweet-1de1a.firebasestorage.app",
    messagingSenderId: "166981707344",
    appId: "1:166981707344:web:fdba2a77f3c280aa491355",
    measurementId: "G-2DMMP787FJ"
  };

  // 🚀 Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // Aquí continúa el resto de tu lógica (login, publicaciones, perfiles, etc.)








// ========== 🔐 AUTENTICACIÓN & PERFIL ==========

// 📌 Iniciar sesión con Google
async function login() {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    console.log("✅ Usuario autenticado:", user);

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        accountType: "google",
        username: user.email.split("@")[0],
        bio: ""
      });
      alert("✅ Usuario nuevo registrado en Firestore");
    } else {
      alert("ℹ️ Usuario ya existía en Firestore");
    }

    // ✅ Cerrar completamente el modal
    const loginModal = document.getElementById("loginModal");
    if (loginModal) {
      loginModal.classList.add("hidden");
      loginModal.style.display = "none";
    }

    await loadUserProfile(user.uid);
    closeModal(); // Opcional, depende de si usas otro modal o animación
  } catch (error) {
    alert("❌ Error en login: " + error.message);
    console.error("❌ Error en login:", error);
  }
}

// 📌 Iniciar sesión como vendedor
async function loginAsSeller() {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    console.log("✅ Usuario autenticado como vendedor:", user);

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        accountType: "seller"
      });
    } else {
      await setDoc(userRef, { accountType: "seller" }, { merge: true });
    }

    // ✅ Cerrar completamente el modal
    const loginModal = document.getElementById("loginModal");
    if (loginModal) {
      loginModal.classList.add("hidden");
      loginModal.style.display = "none";
    }

    closeModal();
    await loadUserProfile(user.uid);
    await syncAccountTypeUI(user);

    const sellerModal = document.getElementById("sellerProfileModal");
    if (sellerModal) {
      sellerModal.classList.remove("hidden");
      sellerModal.style.display = "flex";
    }

  } catch (error) {
    console.error("❌ Error en login como vendedor:", error);
  }
}

// 📌 Cerrar sesión
async function logout() {
  try {
    await auth.signOut();
    console.log("✅ Usuario cerró sesión");

    hideProfileOnLogout(); // Limpia interfaz
    location.reload();     // Refresca para que se oculte todo lo necesario
  } catch (error) {
    console.error("❌ Error al cerrar sesión:", error);
  }
}

// 📌 Cargar perfil general
async function loadUserProfile(uid) {
  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);
    let userData = userSnap.exists() ? userSnap.data() : {};

    document.getElementById("modalProfileName").textContent = userData.name || auth.currentUser.displayName || "Usuario";
    document.getElementById("modalProfileUsername").textContent = userData.username ? "@" + userData.username : "";
    document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biografía";

    const user = auth.currentUser;
    let profilePhoto = userData.modalPhotoURL || userData.photoURL || (user ? user.photoURL : null) || "https://via.placeholder.com/80";
    document.getElementById("profilePicModal").src = profilePhoto;

    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));

    document.getElementById("profilePostCount").textContent = postsSnap.size;
    document.getElementById("profileFollowersCount").textContent = seguidoresSnap.size;
    document.getElementById("profileFollowingCount").textContent = siguiendoSnap.size;

  } catch (error) {
    console.error("❌ Error al cargar perfil:", error);
  }
}

// 📌 Cargar perfil de vendedor
async function loadSellerProfile(uid) {
  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) return;

    const userData = userSnap.data();

    document.getElementById("sellerName").textContent = userData.name || "Vendedor";
    document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("sellerBio").textContent = userData.bio || "Sin biografía";
    document.getElementById("sellerProfilePic").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/100";

    const postsSnap = await getDocs(query(collection(db, "posts"), where("uid", "==", uid)));
    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));

    document.getElementById("sellerTweets").textContent = postsSnap.size;
    document.getElementById("sellerFollowers").textContent = seguidoresSnap.size;
    document.getElementById("sellerFollowing").textContent = siguiendoSnap.size;

  } catch (error) {
    console.error("❌ Error al cargar datos del perfil de vendedor:", error);
  }
}

// 📌 Sincronizar tipo de cuenta en UI
async function syncAccountTypeUI(user) {
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) return;

  const userData = userSnap.data();
  const accountType = userData.accountType || "google";

  const switchBtn = document.getElementById("switchToSellerBtn");
  if (switchBtn) {
    switchBtn.textContent = accountType === "seller"
      ? "Cambiar a cuenta de comprador"
      : "Cambiar a cuenta de vendedor";
  }

  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  if (profileContainerSidebar) {
    profileContainerSidebar.dataset.accountType = accountType;
  }

  if (accountType === "seller") {
    document.getElementById("sellerName").textContent = userData.name || "Vendedor";
    document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("sellerBio").textContent = userData.bio || "Sin biografía";
    const sellerPic = userData.modalPhotoURL || userData.photoURL || user.photoURL || "https://via.placeholder.com/100";
    document.getElementById("sellerProfilePic").src = sellerPic;
    await loadSellerProfile(user.uid);
  }
}

// 📸 Subida de foto de perfil a Cloudinary
const profilePicInput = document.getElementById("profilePicInput");
const saveProfilePicBtn = document.getElementById("saveProfilePicBtn");
const profilePicModal = document.getElementById("profilePicModal");

profilePicInput.addEventListener("change", function () {
  const file = profilePicInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      profilePicModal.src = e.target.result;
    };
    reader.readAsDataURL(file);
    saveProfilePicBtn.classList.remove("hidden");
  }
});

saveProfilePicBtn.addEventListener("click", async function () {
  const user = auth.currentUser;
  if (!user || !profilePicInput.files.length) {
    alert("❌ No hay usuario autenticado o no se seleccionó una imagen.");
    return;
  }

  const file = profilePicInput.files[0];
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "Tweetsocial");

  try {
    alert("📤 Subiendo imagen a Cloudinary...");
    const response = await fetch("https://api.cloudinary.com/v1_1/dz70korgo/image/upload", {
      method: "POST",
      body: formData
    });

    const data = await response.json();
    if (!data.secure_url) throw new Error("No se recibió una URL válida de Cloudinary.");

    const photoURL = data.secure_url;
    alert("✅ Imagen subida correctamente.");

    const userRef = doc(db, "usuarios", user.uid);
    await setDoc(userRef, { modalPhotoURL: photoURL }, { merge: true });

    document.getElementById("profilePicModal").src = photoURL;
    document.getElementById("editProfilePic").src = photoURL;
    saveProfilePicBtn.classList.add("hidden");

  } catch (error) {
    alert("❌ Error al subir la imagen: " + error.message);
    console.error("Error detallado:", error);
  }
});

// 📌 Actualizar UI del perfil
function updateUI(user) {
  if (!user) return;

  const profilePic = document.getElementById("profilePic");
  const profilePicSidebar = document.getElementById("profilePicSidebar");
  const profileName = document.getElementById("profileName");
  const mainPhoto = user.photoURL || "https://via.placeholder.com/40";

  if (profilePic) profilePic.src = mainPhoto;
  if (profilePicSidebar) profilePicSidebar.src = mainPhoto;
  if (profileName) profileName.textContent = user.name || "Usuario";

  const profileContainer = document.getElementById("profileContainer");
  if (profileContainer) profileContainer.dataset.userType = user.accountType;

  if (user.accountType === "google") {
    document.getElementById("sellerProfileModal")?.classList.add("hidden");
    document.getElementById("googleProfileModal")?.classList.remove("hidden");
  } else if (user.accountType === "seller") {
    document.getElementById("googleProfileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.remove("hidden");
  }
}





















// 🔐 AUTENTICACIÓN Y MANEJO DE SESIÓN

let unsubscribePosts = null;
let userDataLoaded = false;
let currentAccountType = "usuario";

onAuthStateChanged(auth, async (user) => {
  console.log("🔄 Detectando cambios en la sesión...", user);

  const loginBtn = document.getElementById("loginBtn");
  const profileContainer = document.getElementById("profileContainer");
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  const publishBtn = document.getElementById("publishBtn");

  const mobileProfilePic = document.getElementById("mobileProfilePic");
  const mobileProfileIcon = document.getElementById("mobileProfileIcon");
  const mobilePerfilBtn = document.getElementById("mobilePerfilBtn");

  if (user) {
    console.log("✅ Sesión detectada: ", user.uid);
    let mainPhoto = user.photoURL || "https://via.placeholder.com/40";

    try {
      const userRef = doc(db, "usuarios", user.uid);
      const userSnap = await getDoc(userRef);
      let userData = userSnap.exists() ? userSnap.data() : null;

      if (!userData) {
        userData = {
          uid: user.uid,
          username: user.displayName?.toLowerCase().replace(/\s+/g, "_") || "usuario_" + user.uid.slice(0, 4),
          name: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40",
          modalPhotoURL: user.photoURL || "https://via.placeholder.com/40",
          accountType: "usuario",
          createdAt: serverTimestamp()
        };
        await setDoc(userRef, userData);
        console.log("📝 Perfil creado correctamente en Firestore.");
        await new Promise(res => setTimeout(res, 300));
      }

      currentAccountType = userData.accountType || "usuario";
      mainPhoto = userData.modalPhotoURL || userData.photoURL || mainPhoto;

      updateProfileUI(userData, mainPhoto);
      await syncAccountTypeUI(user);
      setupProfileClickHandlers(userData, mainPhoto);

      if (unsubscribePosts) unsubscribePosts();
      setTimeout(() => listenForPosts(), 400);

      userDataLoaded = true;
      if (publishBtn) publishBtn.disabled = false;

    } catch (error) {
      console.error("❌ Error al recuperar/crear datos del usuario:", error);
      if (publishBtn) publishBtn.disabled = true;
      userDataLoaded = false;
    }
  } else {
    handleLogoutUI();
    if (unsubscribePosts) unsubscribePosts();
    if (publishBtn) publishBtn.disabled = true;
    userDataLoaded = false;
  }
});

function updateProfileUI(userData, mainPhoto) {
  const profileElements = [
    { id: "profilePicModal", prop: "src", value: mainPhoto },
    { id: "profileName", prop: "textContent", value: userData.name || "Usuario" },
    { id: "profilePic", prop: "src", value: mainPhoto },
    { id: "profilePicSidebar", prop: "src", value: mainPhoto },
    { id: "usernameSidebar", prop: "textContent", value: userData.name || "Usuario" },
    { id: "mobileProfilePic", prop: "src", value: mainPhoto }
  ];

  profileElements.forEach(el => {
    const element = document.getElementById(el.id);
    if (element) {
      if (el.prop === "src") element.src = el.value;
      else element[el.prop] = el.value;
    }
  });

  const mobileProfilePic = document.getElementById("mobileProfilePic");
  const mobileProfileIcon = document.getElementById("mobileProfileIcon");
  if (mobileProfilePic && mobileProfileIcon) {
    mobileProfilePic.classList.remove("hidden");
    mobileProfileIcon.classList.add("hidden");
  }

  const loginBtn = document.getElementById("loginBtn");
  const profileContainer = document.getElementById("profileContainer");
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");

  if (loginBtn) loginBtn.style.display = "none";
  if (profileContainer) profileContainer.style.display = "block";
  if (profileContainerSidebar) profileContainerSidebar.classList.remove("hidden");
}

function setupProfileClickHandlers(userData, mainPhoto) {
  const showProfileModal = () => {
    const profileModal = document.getElementById("profileModal");
    const sellerProfileModal = document.getElementById("sellerProfileModal");

    // Oculta ambos antes de mostrar el adecuado
    if (profileModal) profileModal.style.display = "none";
    if (sellerProfileModal) sellerProfileModal.style.display = "none";

    if (userData.accountType === "vendedor") {
      const sellerModal = document.getElementById("sellerProfileModal");
      if (sellerModal) {
        document.getElementById("sellerProfilePic").src = mainPhoto;
        document.getElementById("sellerName").textContent = userData.name || "Vendedor";
        document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
        document.getElementById("sellerBio").textContent = userData.bio || "";
        sellerModal.style.display = "flex"; // aseguramos visibilidad
      }
    } else {
      const userModal = document.getElementById("profileModal");
      if (userModal) {
        document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
        document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
        document.getElementById("modalProfileBio").textContent = userData.bio || "";
        document.getElementById("profilePicModal").src = mainPhoto;
        userModal.style.display = "flex";
        document.getElementById("modalContent")?.classList.remove("scale-95", "opacity-0");
      }
    }
  };

  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  if (profileContainerSidebar) {
    profileContainerSidebar.onclick = showProfileModal;
  }

  const mobilePerfilBtn = document.getElementById("mobilePerfilBtn");
  if (mobilePerfilBtn) {
    mobilePerfilBtn.onclick = showProfileModal;
  }
}

function handleLogoutUI() {
  console.log("🚪 No hay usuario, cerrando sesión visual...");

  const loginBtn = document.getElementById("loginBtn");
  const profileContainer = document.getElementById("profileContainer");
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");

  if (loginBtn) loginBtn.style.display = "block";
  if (profileContainer) profileContainer.style.display = "none";
  if (profileContainerSidebar) profileContainerSidebar.classList.add("hidden");

  const mobileProfilePic = document.getElementById("mobileProfilePic");
  const mobileProfileIcon = document.getElementById("mobileProfileIcon");
  if (mobileProfilePic && mobileProfileIcon) {
    mobileProfilePic.classList.add("hidden");
    mobileProfileIcon.classList.remove("hidden");
  }

  const loginModal = document.getElementById("loginModal");

  const openLoginModal = () => {
    if (loginModal) loginModal.classList.remove("hidden");
  };

  const mobilePerfilBtn = document.getElementById("mobilePerfilBtn");
  if (mobilePerfilBtn) {
    mobilePerfilBtn.removeEventListener("click", openLoginModal);
    mobilePerfilBtn.addEventListener("click", openLoginModal);
  }

  if (profileContainerSidebar) {
    profileContainerSidebar.removeEventListener("click", openLoginModal);
    profileContainerSidebar.addEventListener("click", openLoginModal);
  }

  hideProfileOnLogout();
}















// 📌 Función para ocultar el perfil al cerrar sesión
function hideProfileOnLogout() {
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    profileContainerSidebar?.classList.add("hidden");

    const profilePic = document.getElementById("profilePic");
    const profileName = document.getElementById("profileName");
    const profilePicSidebar = document.getElementById("profilePicSidebar");
    const loginBtn = document.getElementById("loginBtn");

    if (profilePic) profilePic.src = "";
    if (profileName) profileName.textContent = "";
    if (profilePicSidebar) profilePicSidebar.src = "";
    if (loginBtn) loginBtn.style.display = "block";
}


// ✅ Notificaciones tipo toast
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type} fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg transition`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}


// ✅ Inicializar persistencia de Firestore
async function enablePersistence() {
    try {
        await enableIndexedDbPersistence(db);
        console.log("📦 Persistencia de Firestore habilitada");
    } catch (err) {
        if (err.code === 'failed-precondition') {
            console.warn("⚠️ Persistencia falló: Múltiples pestañas abiertas");
        } else if (err.code === 'unimplemented') {
            console.warn("⚠️ Persistencia no soportada en este navegador");
        }
    }
}
enablePersistence();




// ========== 👥 SEGUIDORES ==========
async function loadFollowingInMessages() {
  const currentUser = auth.currentUser;
  const followingListContainer = document.getElementById("followingList");

  if (!currentUser || !followingListContainer) return;

  try {
    const seguidosRef = collection(db, "usuarios", currentUser.uid, "seguidos");
    const snapshot = await getDocs(seguidosRef);

    followingListContainer.innerHTML = "";

    if (snapshot.empty) {
      followingListContainer.innerHTML = `<p class="text-sm text-gray-500">No sigues a nadie aún.</p>`;
      return;
    }

    for (const docSnap of snapshot.docs) {
      const seguidoUID = docSnap.id;
      const seguidoRef = doc(db, "usuarios", seguidoUID);
      const seguidoSnap = await getDoc(seguidoRef);

      if (seguidoSnap.exists()) {
        const data = seguidoSnap.data();
        const name = data.name || "Sin nombre";
        const photo = data.modalPhotoURL || data.photoURL || "https://via.placeholder.com/80";

        const userDiv = document.createElement("div");
        userDiv.className = "flex flex-col items-center cursor-pointer";
        userDiv.innerHTML = `
          <img src="${photo}" class="w-12 h-12 rounded-full border-2 border-green-400" alt="${name}">
          <span class="text-xs font-medium mt-1">${name}</span>
        `;

        userDiv.addEventListener("click", () => {
          openChatWithUser(seguidoUID);
        });

        followingListContainer.appendChild(userDiv);
      }
    }
  } catch (error) {
    console.error("❌ Error al cargar usuarios seguidos:", error);
    followingListContainer.innerHTML = `<p class="text-sm text-red-500">Error al cargar usuarios.</p>`;
  }
}


// ✅ Cargar contadores del perfil vendedor
async function loadSellerCounts(uid) {
  try {
    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    document.getElementById("sellerTweets").textContent = postsSnap.size;

    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    document.getElementById("sellerFollowers").textContent = seguidoresSnap.size;

    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
    document.getElementById("sellerFollowing").textContent = siguiendoSnap.size;

    console.log("📊 Contadores de vendedor cargados:", uid);
  } catch (error) {
    console.error("❌ Error al cargar contadores de vendedor:", error);
  }
}

// ✅ Cargar contadores del perfil normal
async function loadProfileCounts(uid) {
  try {
    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    document.getElementById("profilePostCount").textContent = postsSnap.size;

    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    document.getElementById("profileFollowersCount").textContent = seguidoresSnap.size;

    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
    document.getElementById("profileFollowingCount").textContent = siguiendoSnap.size;

    console.log("📊 Contadores cargados correctamente para:", uid);
  } catch (error) {
    console.error("❌ Error al contar publicaciones o seguidores:", error);
  }
}



















// ========== 🔧 FUNCIONES GLOBALES ==========
function openModal() {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  getDoc(userRef).then(async (userSnap) => {
    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const accountType = userData.accountType || "google";

    // Al abrir el modal, ocultamos el sidebar de PC y mostramos el móvil
    toggleSidebar(true);

    if (accountType === "seller") {
      const sellerModal = document.getElementById("sellerProfileModal");
      sellerModal?.classList.remove("hidden");
      sellerModal.style.display = "flex";
    } else {
      const profileModal = document.getElementById("profileModal");
      const modalOverlay = document.getElementById("modalOverlay");
      const modalContent = document.getElementById("modalContent");

      if (!profileModal || !modalOverlay || !modalContent) {
        console.error("❌ No se encontraron elementos del modal.");
        return;
      }

      profileModal.classList.remove("hidden");
      profileModal.style.display = "flex";
      modalOverlay.classList.remove("hidden");

      setTimeout(() => {
        modalContent.classList.remove("scale-95", "opacity-0");
        modalContent.classList.add("scale-100", "opacity-100");
      }, 10);

      document.body.style.overflow = "hidden";

      document.getElementById("profilePicModal").src = user.photoURL || "https://via.placeholder.com/80";
      document.getElementById("openEditProfileFromModal")?.classList.remove("hidden");
      document.getElementById("followBtn")?.classList.add("hidden");

      await loadUserProfile(user.uid);
      await loadProfileCounts(user.uid);
      loadUserPosts(user.uid); // 👈 para mostrar solo tus publicaciones
    }
  }).catch((error) => {
    console.error("❌ Error al abrir modal de perfil:", error);
  });
}

function closeModal() {
  const profileModal = document.getElementById("profileModal");
  const modalOverlay = document.getElementById("modalOverlay");
  const modalContent = document.getElementById("modalContent");

  if (!profileModal || !modalOverlay || !modalContent) return;

  modalContent.classList.add("scale-95", "opacity-0");
  modalContent.classList.remove("scale-100", "opacity-100");

  setTimeout(() => {
    profileModal.classList.add("hidden");
    profileModal.style.display = "none";
    modalOverlay.classList.add("hidden"); // Ocultamos el overlay al cerrar el modal
    document.body.style.overflow = "auto";

    // Al cerrar el modal, mostramos nuevamente el sidebar de PC y ocultamos el móvil
    toggleSidebar(false);
  }, 300);
}

// Función para alternar visibilidad del sidebar de PC y móvil
function toggleSidebar(open) {
  const pcSidebar = document.getElementById("pcSidebar");
  const mobileSidebar = document.getElementById("mobileSidebar");
  const modalOverlay = document.getElementById("modalOverlay");

  if (open) {
    // Si queremos abrir el modal, ocultamos el sidebar de PC y mostramos el móvil
    pcSidebar?.classList.add("hidden");
    mobileSidebar?.classList.remove("hidden");
    modalOverlay?.classList.add("hidden"); // Aseguramos que el overlay también se oculte
  } else {
    // Si cerramos el modal, volvemos a mostrar el sidebar de PC y ocultamos el móvil
    pcSidebar?.classList.remove("hidden");
    mobileSidebar?.classList.add("hidden");
    modalOverlay?.classList.remove("hidden"); // Si es necesario, mostramos el overlay de nuevo
  }
}




// ✅ Listeners para el modal (PC y móvil)
document.addEventListener("DOMContentLoaded", () => {
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  const mobilePerfilBtn = document.getElementById("mobilePerfilBtn");
  const closeProfileModal = document.getElementById("closeProfileModal");
  const modalOverlay = document.getElementById("modalOverlay");

  profileContainerSidebar?.addEventListener("click", openModal);
  mobilePerfilBtn?.addEventListener("click", openModal);
  closeProfileModal?.addEventListener("click", closeModal);
  modalOverlay?.addEventListener("click", closeModal);

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      closeModal();
    }
  });
});

// 👉 Abrir modal de login
document.getElementById("loginBtn")?.addEventListener("click", () => {
  const modal = document.getElementById("loginModal");
  if (modal) {
    modal.classList.remove("hidden");
  }
});

// 👉 Cerrar modal de login
document.getElementById("closeModal")?.addEventListener("click", () => {
  const modal = document.getElementById("loginModal");
  if (modal) {
    modal.classList.add("hidden");
  }
});

// 👉 Listener para botón de login como vendedor
document.getElementById("sellerLoginBtn")?.addEventListener("click", () => {
  loginAsSeller(); // ya tienes esta función definida
});

// 👉 Listener para botón de login con Google
document.getElementById("googleLoginBtn")?.addEventListener("click", () => {
  login(); // también tienes esta función
});














// ========== 📝 PUBLICACIONES ==========

// 👉 Abrir modal de perfil desde publicación (siempre muestra perfil normal)
window.openModalFromPost = function(uid) {
  getDoc(doc(db, "usuarios", uid)).then(userSnap => {
    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const currentUser = auth.currentUser;

    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biografía";
    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";

    const editBtn = document.getElementById("openEditProfileFromModal");
    const followBtn = document.getElementById("followBtn");

    if (currentUser && currentUser.uid === uid) {
      editBtn.classList.remove("hidden");
      followBtn.classList.add("hidden");
    } else {
      editBtn.classList.add("hidden");
      followBtn.classList.remove("hidden");
      followBtn.textContent = "Seguir";
    }

    const modal = document.getElementById("profileModal");
    const modalContent = document.getElementById("modalContent");
    const modalOverlay = document.getElementById("modalOverlay");

    modal.classList.remove("hidden");
    modal.style.display = "flex";
    if (modalOverlay) {
      modalOverlay.classList.remove("hidden");
      modalOverlay.style.display = "block";
    }

    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);

    loadUserProfile(uid);
  }).catch(error => {
    console.error("❌ Error al abrir modal desde publicación:", error);
    alert("❌ No se pudo abrir el perfil.");
  });
};

// 👉 Detectar clic en nombre o foto para abrir modal


// Clic en nombre (username)
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("username-link")) {
    e.preventDefault();      // Prevenir comportamiento del navegador
    e.stopPropagation();     // Evitar propagación innecesaria
    const uid = e.target.dataset.uid;
    if (uid) openModalFromPost(uid);
  }
});

// Clic en imagen de perfil para vista previa
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("profile-pic-clickable")) {
    const modal = document.getElementById("profilePicPreviewModal");
    const img = document.getElementById("previewProfilePic");
    img.src = e.target.dataset.img;
    modal.classList.remove("hidden");
  }
});

// Cerrar vista previa de imagen
document.getElementById("profilePicPreviewModal")?.addEventListener("click", (e) => {
  if (e.target.id === "profilePicPreviewModal") {
    e.currentTarget.classList.add("hidden");
  }
});


// 👉 Publicar un post

document.getElementById("publishBtn")?.addEventListener("click", async (e) => {
  const btn = e.currentTarget;
  btn.disabled = true;
  btn.textContent = "Publicando...";

  const text = document.getElementById("postInput").value.trim();
  const imageInput = document.getElementById("postImageInput");
  const file = imageInput.files[0];

  if (!text && !file) {
    alert("⚠️ Escribe algo o sube una imagen, video o archivo.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("⚠️ Debes estar logueado.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  if (!userDataLoaded) {
    alert("⚠️ Espera a que se cargue tu perfil correctamente antes de publicar.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  let mediaURL = "";
  let isVideo = false;
  let fileType = "";
  let originalFileName = "";

  if (file) {
    try {
      fileType = file.type;
      originalFileName = file.name;

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "Tweetsocial");

      let uploadURL = "";

      if (fileType.startsWith("video/")) {
        isVideo = true;
        uploadURL = "https://api.cloudinary.com/v1_1/dz70korgo/video/upload";
      } else if (fileType.startsWith("image/")) {
        uploadURL = "https://api.cloudinary.com/v1_1/dz70korgo/image/upload";
      } else {
        uploadURL = "https://api.cloudinary.com/v1_1/dz70korgo/raw/upload";
      }

      const response = await fetch(uploadURL, {
        method: "POST",
        body: formData,
      });

      const data = await response.json();
      if (!data.secure_url) throw new Error("No se pudo subir a Cloudinary");

      mediaURL = data.secure_url;
    } catch (error) {
      console.error("❌ Error al subir archivo:", error);
      alert("❌ Ocurrió un error al subir el archivo.");
      btn.disabled = false;
      btn.textContent = "Publicar";
      return;
    }
  }

  let profileData = {};
  try {
    const userSnap = await getDoc(doc(db, "usuarios", user.uid));
    if (userSnap.exists()) {
      const data = userSnap.data();
      profileData = {
        accountType: data.accountType || "",
        bio: data.bio || "",
        modalPhotoURL: data.modalPhotoURL || "",
        name: data.name || "",
        username: data.username || "",
        photoURL: data.photoURL || "",
      };
    }
  } catch (e) {
    console.warn("⚠️ No se pudo obtener perfil del usuario:", e);
  }

  try {
    await addDoc(collection(db, "posts"), {
      uid: user.uid,
      text,
      mediaURL,
      isVideo,
      fileType,
      fileName: originalFileName,
      timestamp: serverTimestamp(),
      ...profileData,
    });

    document.getElementById("postInput").value = "";
    imageInput.value = "";
    alert("✅ Publicación realizada con éxito.");
  } catch (err) {
    console.error("❌ Error al guardar la publicación:", err);
    alert("❌ Error al guardar la publicación en Firestore.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Publicar";
  }
});






















// ========== 📝 PUBLICACIONES ==========
function renderPostHTML(docData, userData = {}, postId = "") {
  const uid = docData?.uid || userData?.uid || "";
  const timestamp = new Date(docData.timestamp?.toDate?.() || Date.now()).toLocaleString();

  const safeUser = {
    username: docData.username || userData.username || "usuario",
    name: docData.name || userData.name || "Usuario",
    photoURL: docData.modalPhotoURL || docData.photoURL || userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/40",
    accountType: docData.accountType || userData.accountType || "usuario"
  };

  const userHeader = `
    <div class="flex items-center mb-3">
      <img src="${safeUser.photoURL}" alt="Foto de ${safeUser.name}"
        class="w-10 h-10 rounded-full object-cover border-2 cursor-pointer profile-pic-clickable"
        data-uid="${uid}" data-account-type="${safeUser.accountType}"
        onerror="this.src='https://via.placeholder.com/40'" />
      <div class="ml-3">
        <span class="font-medium text-blue-600 cursor-pointer username-link hover:text-blue-800"
          data-uid="${uid}" data-account-type="${safeUser.accountType}">@${safeUser.username}</span>
        <div class="text-xs text-gray-500">${timestamp}</div>
      </div>
    </div>
  `;

  const mediaBlock = (() => {
    const src = docData.imagen || docData.mediaURL;
    const fileType = src?.split('.').pop()?.toLowerCase();
    if (!src) return "";

    if (docData.isVideo || fileType === "mp4") {
      return `
        <div class="relative bg-white flex justify-center items-center border rounded-lg overflow-hidden">
          <video class="media-clickable w-full max-h-[600px] object-contain cursor-pointer" src="${src}" controls></video>
        </div>`;
    }

    if (["jpg", "jpeg", "png", "gif", "webp"].includes(fileType)) {
      return `
        <div class="relative flex justify-center items-center bg-white border rounded-lg overflow-hidden">
          <img src="${src}" alt="Contenido"
            class="media-clickable w-full max-h-[600px] object-contain cursor-pointer"
            onerror="this.style.display='none'" />
        </div>`;
    }

    if (["mp3", "wav", "ogg"].includes(fileType)) {
      return `
        <div class="my-3 bg-white p-3 border rounded-lg">
          <audio controls class="w-full">
            <source src="${src}" type="audio/${fileType}" />
            Tu navegador no soporta audio embebido.
          </audio>
        </div>`;
    }

    if (fileType === "pdf") {
      return `
        <div class="my-3 bg-white border rounded-lg overflow-hidden">
          <embed src="${src}" type="application/pdf" class="w-full h-[500px]" />
          <p class="text-sm p-3 border-t">
            <a href="${src}" target="_blank" class="underline text-blue-600 hover:text-blue-800">Ver PDF en nueva pestaña</a>
          </p>
        </div>`;
    }

    return `
      <div class="my-3 p-3 border rounded-lg bg-white flex items-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v16m8-8H4" />
        </svg>
        <a href="${src}" download target="_blank" class="text-blue-600 underline hover:text-blue-800">
          Descargar archivo (${fileType.toUpperCase()})
        </a>
      </div>`;
  })();

  const commentsBlock = `
    <div class="comments-section hidden mt-4 pt-3 border-t border-gray-200">
      <div class="comments-list space-y-3 mb-3"></div>
      <div class="flex">
        <input type="text" class="comment-input flex-grow border p-3 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Escribe un comentario..." />
        <button class="comment-submit px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-r-lg transition-colors" data-post-id="${postId}">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
            viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
    </div>
  `;

  const interactionButtons = (postId) => `
    <div class="flex space-x-3 mt-3">
      <button class="toggle-comments-btn bg-white hover:bg-gray-50 px-3 py-2 rounded-full border transition-colors flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 8h2a2 2 0 012 2v9a2 2 0 01-2 2h-2M7 8H5a2 2 0 00-2 2v9a2 2 0 002 2h2m0-14V4a2 2 0 012-2h6a2" />
        </svg>
        <span class="ml-1 text-sm">Comentarios</span>
      </button>

      <button class="like-btn bg-white hover:bg-gray-50 px-3 py-2 rounded-full border transition-colors flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M5 15l7-7 7 7" />
        </svg>
        <span class="ml-1 text-sm">Me gusta</span>
      </button>

      <button class="share-btn bg-white hover:bg-gray-50 px-3 py-2 rounded-full border transition-colors flex items-center" onclick="sharePost('${postId}')">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
        </svg>
        <span class="ml-1 text-sm">Compartir</span>
      </button>
    </div>
  `;

if (docData.tipo === "venta") {
  const numeroWhatsApp = docData.whatsapp ? docData.whatsapp.replace(/\D/g, '') : null;

  return `
    <div class="post bg-white p-5 rounded-lg shadow-md mt-4 border border-gray-200" data-post-id="${postId}">
      ${userHeader}
      <h3 class="text-xl font-bold text-gray-800 mb-2">${docData.titulo || "Producto sin título"}</h3>
      <p class="text-gray-700 mb-3 leading-relaxed">${docData.descripcion || ""}</p>
      
      ${mediaBlock || ""}

      <div class="bg-blue-100 p-4 rounded-lg mb-3 text-center text-blue-800 font-bold">
        💰 Precio: ${docData.precio || "No especificado"}
      </div>

      <div class="flex justify-between items-center mt-3">
        <div class="flex space-x-2">
          ${interactionButtons(postId)}
        </div>

        ${numeroWhatsApp ? `
          <a href="https://wa.me/${numeroWhatsApp}" target="_blank"
            class="comprar-btn bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-full shadow-md transition-all flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none"
              viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17" />
            </svg>
            Comprar
          </a>
        ` : ""}
      </div>

      ${commentsBlock}
    </div>
  `;
}

  return `
    <div class="post bg-white p-5 rounded-lg shadow-md mt-4 border border-gray-200 hover:shadow-lg transition-shadow" data-post-id="${postId}">
      ${userHeader}
      <p class="text-gray-700 mb-3 leading-relaxed">${docData.text || ""}</p>
      ${mediaBlock}
      ${interactionButtons(postId)}
      ${commentsBlock}
    </div>
  `;
}






















// ========== 👥 SEGUIDORES ==========

document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("username-link")) return;

  const uid = e.target.dataset.uid;
  if (!uid) {
    alert("❌ No se pudo identificar el UID del usuario.");
    return;
  }

  console.log("🔍 Clic en username, buscando datos para UID:", uid);

  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      alert("❌ Usuario no encontrado en Firestore.");
      return;
    }

    const userData = userSnap.data();
    console.log("✅ Datos del usuario:", userData);

    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";
    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "";

    const editBtn = document.getElementById("openEditProfileFromModal");
    const followBtn = document.getElementById("followBtn");
    const currentUser = auth.currentUser;
    const isOwnProfile = currentUser && currentUser.uid === uid;

    if (isOwnProfile) {
      editBtn?.classList.remove("hidden");
      followBtn?.classList.add("hidden");
    } else {
      editBtn?.classList.add("hidden");
      followBtn?.classList.remove("hidden");

      followBtn.dataset.uid = uid;

      const followRef = doc(db, "usuarios", uid, "seguidores", currentUser.uid);
      const followSnap = await getDoc(followRef);

      if (followSnap.exists()) {
        followBtn.textContent = "Siguiendo";
        followBtn.classList.remove("bg-blue-500");
        followBtn.classList.add("bg-green-500");
      } else {
        followBtn.textContent = "Seguir";
        followBtn.classList.remove("bg-green-500");
        followBtn.classList.add("bg-blue-500");
      }
    }

    const modal = document.getElementById("profileModal");
    const content = document.getElementById("modalContent");

    modal.classList.remove("hidden");
    modal.style.display = "flex";

    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

  } catch (err) {
    console.error("❌ Error al obtener perfil:", err);
    alert("❌ No se pudo abrir el perfil.\n\n" + err.message);
  }
});

document.getElementById("followBtn")?.addEventListener("click", async function () {
  const followBtn = this;
  const viewedUID = followBtn.dataset.uid;
  const currentUser = auth.currentUser;

  if (!viewedUID || !currentUser) {
    alert("❌ No se pudo procesar el seguimiento.");
    return;
  }

  const followerRef = doc(db, "usuarios", viewedUID, "seguidores", currentUser.uid);
  const followingRef = doc(db, "usuarios", currentUser.uid, "seguidos", viewedUID);

  try {
    const docSnap = await getDoc(followerRef);

    if (docSnap.exists()) {
      await deleteDoc(followerRef);
      await deleteDoc(followingRef);

      followBtn.textContent = "Seguir";
      followBtn.classList.remove("bg-green-500");
      followBtn.classList.add("bg-blue-500");
    } else {
      await setDoc(followerRef, {
        seguidorUID: currentUser.uid,
        followedAt: Date.now()
      });
      await setDoc(followingRef, {
        seguidoUID: viewedUID,
        followedAt: Date.now()
      });

      followBtn.textContent = "Siguiendo";
      followBtn.classList.remove("bg-blue-500");
      followBtn.classList.add("bg-green-500");
    }

    await loadProfileCounts(viewedUID);

  } catch (error) {
    console.error("❌ Error al seguir/dejar de seguir:", error);
    alert("❌ Hubo un error al actualizar el seguimiento.\n\n" + error.message);
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const profileModal = document.getElementById("profilePicPreviewModal");
  const profileImgPreview = document.getElementById("previewProfilePic");

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("profile-pic-clickable")) {
      const src = e.target.getAttribute("src");
      profileImgPreview.src = src;
      profileModal.classList.remove("hidden");
    }
  });

  profileModal.addEventListener("click", (e) => {
    if (e.target === profileModal) {
      profileModal.classList.add("hidden");
      profileImgPreview.src = "";
    }
  });
});









// ========== 🧑 PERFIL - EDICIÓN ==========

// 👉 Botón 'Editar perfil' desde el modal
document.getElementById("openEditProfileFromModal")?.addEventListener("click", () => {
  closeModal();
  openEditProfileModal();
});

// 👉 Función para abrir el modal de edición de perfil
function openEditProfileModal() {
  const modal = document.getElementById("editProfileModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.style.display = "flex";
  setTimeout(() => {
    modal.classList.remove("scale-95", "opacity-0");
    modal.classList.add("scale-100", "opacity-100");
  }, 10);

  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  getDoc(userRef).then((snap) => {
    if (!snap.exists()) return;
    const data = snap.data();
    document.getElementById("editProfilePic").src = data.modalPhotoURL || user.photoURL || "https://via.placeholder.com/80";
    document.getElementById("editProfileName").value = data.name || user.displayName || "";
    document.getElementById("editProfileUsername").value = (data.username || "").replace(/^@/, "");
    document.getElementById("editProfileBio").value = data.bio || "";

    const switchBtn = document.getElementById("switchToSellerBtn");
    if (switchBtn) {
      switchBtn.textContent = data.accountType === "seller"
        ? "Cambiar a cuenta de comprador"
        : "Cambiar a cuenta de vendedor";
    }
  }).catch(err => console.error("❌ Error al cargar datos para editar:", err));
}

// 👉 Botón 'Editar perfil' desde el perfil de vendedor
document.getElementById("editSellerProfileBtn")?.addEventListener("click", () => {
  document.getElementById("sellerProfileModal")?.classList.add("hidden");
  document.getElementById("sellerProfileModal").style.display = "none";
  openEditProfileModal();
});

// 👉 Guardar perfil editado
document.getElementById("saveProfileBtn")?.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("❌ No hay usuario autenticado.");

  const name = document.getElementById("editProfileName").value.trim();
  const username = document.getElementById("editProfileUsername").value.trim().replace(/^@/, "");
  const bio = document.getElementById("editProfileBio").value.trim();

  try {
    await updateProfile(user, { displayName: name });
    const ref = doc(db, "usuarios", user.uid);
    await setDoc(ref, { name, username, bio }, { merge: true });

    alert("✅ Perfil actualizado con éxito.");
    await loadUserProfile(user.uid);

    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      document.getElementById("modalProfileName").textContent = data.name;
      document.getElementById("modalProfileUsername").textContent = "@" + data.username;
      document.getElementById("modalProfileBio").textContent = data.bio || "Sin biografía";
    }

    document.getElementById("editProfileModal")?.classList.add("hidden");
  } catch (err) {
    console.error("❌ Error al actualizar el perfil:", err);
    alert("❌ Error al guardar los cambios.\n" + err.message);
  }
});

// 👉 Cambiar entre cuenta normal y vendedor
document.getElementById("switchToSellerBtn")?.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("❌ No hay usuario autenticado.");

  const ref = doc(db, "usuarios", user.uid);
  const snap = await getDoc(ref);
  if (!snap.exists()) return alert("⚠️ No se encontraron datos del usuario.");

  const current = snap.data().accountType || "google";
  const newType = current === "seller" ? "google" : "seller";

  await setDoc(ref, { accountType: newType }, { merge: true });
  alert(`✅ Tu cuenta ahora es tipo: ${newType}`);

  const switchBtn = document.getElementById("switchToSellerBtn");
  if (switchBtn) {
    switchBtn.textContent = newType === "seller"
      ? "Cambiar a cuenta de comprador"
      : "Cambiar a cuenta de vendedor";
  }

  // Cerrar todos los modales abiertos
  document.getElementById("editProfileModal")?.classList.add("hidden");
  document.getElementById("profileModal")?.classList.add("hidden");
  document.getElementById("profileModal").style.display = "none";
  document.getElementById("sellerProfileModal")?.classList.add("hidden");
  document.getElementById("sellerProfileModal").style.display = "none";

  const updatedSnap = await getDoc(ref);
  if (!updatedSnap.exists()) return;
  const data = updatedSnap.data();

  if (newType === "seller") {
    document.getElementById("sellerName").textContent = data.name || "Vendedor";
    document.getElementById("sellerUsername").textContent = "@" + (data.username || "usuario");
    document.getElementById("sellerBio").textContent = data.bio || "Sin biografía";
    document.getElementById("sellerProfilePic").src = data.modalPhotoURL || data.photoURL || user.photoURL || "https://via.placeholder.com/100";

    const modal = document.getElementById("sellerProfileModal");
    modal?.classList.remove("hidden");
    modal.style.display = "flex";

    await loadSellerCounts(user.uid);
  }
});

// 👉 Listeners para pedidos, ingresos y cerrar modal vendedor
if (!window.__MODAL_PERFIL_VENDEDOR_ACTIVO) {
  window.__MODAL_PERFIL_VENDEDOR_ACTIVO = true;

  document.addEventListener("DOMContentLoaded", () => {
    const openOrdersBtn = document.getElementById("openOrdersModal");
    const ordersModal = document.getElementById("ordersModal");
    const closeOrdersBtn = document.getElementById("closeOrdersModal");

    openOrdersBtn?.addEventListener("click", () => {
      ordersModal?.classList.remove("hidden");
      ordersModal.style.display = "flex";
    });

    closeOrdersBtn?.addEventListener("click", () => {
      ordersModal?.classList.add("hidden");
      ordersModal.style.display = "none";
    });

    ordersModal?.addEventListener("click", (e) => {
      if (e.target.id === "ordersModal") {
        ordersModal.classList.add("hidden");
        ordersModal.style.display = "none";
      }
    });

    const openEarningsBtn = document.getElementById("openEarningsModal");
    const earningsModal = document.getElementById("earningsModal");
    const closeEarningsBtn = document.getElementById("closeEarningsModal");

    openEarningsBtn?.addEventListener("click", () => {
      earningsModal?.classList.remove("hidden");
      earningsModal.style.display = "flex";
    });

    closeEarningsBtn?.addEventListener("click", () => {
      earningsModal?.classList.add("hidden");
      earningsModal.style.display = "none";
    });

    earningsModal?.addEventListener("click", (e) => {
      if (e.target.id === "earningsModal") {
        earningsModal.classList.add("hidden");
        earningsModal.style.display = "none";
      }
    });

    const closeSellerBtn = document.getElementById("closeSellerModal");
    const sellerModal = document.getElementById("sellerProfileModal");

    closeSellerBtn?.addEventListener("click", () => {
      sellerModal?.classList.add("hidden");
      sellerModal.style.display = "none";
    });

    sellerModal?.addEventListener("click", (e) => {
      if (e.target.id === "sellerProfileModal") {
        sellerModal.classList.add("hidden");
        sellerModal.style.display = "none";
      }
    });
  });
}

// 👉 Botón 'Cerrar sesión' desde modal de edición
document.getElementById("logoutBtn")?.addEventListener("click", async () => {
  try {
    document.getElementById("editProfileModal")?.classList.add("hidden"); // Cierra el modal antes
    await auth.signOut();
    console.log("✅ Usuario cerró sesión");
    hideProfileOnLogout(); // Limpia la UI
    location.reload();     // 🔁 Refresca la app
  } catch (error) {
    console.error("❌ Error al cerrar sesión:", error);
    alert("❌ Error al cerrar sesión.");
  }
});

// 👉 Botón para cerrar el modal de edición de perfil (con animación)
document.getElementById("closeEditProfileModal")?.addEventListener("click", () => {
  const modal = document.getElementById("editProfileModal");
  if (!modal) return;

  modal.classList.remove("scale-100", "opacity-100");
  modal.classList.add("scale-95", "opacity-0");

  setTimeout(() => {
    modal.classList.add("hidden");
    modal.style.display = "none";
  }, 300); // tiempo de la animación
});

// 👉 Cerrar modal de edición al tocar fuera (overlay)
document.getElementById("editProfileModal")?.addEventListener("click", (e) => {
  if (e.target.id === "editProfileModal") {
    const modal = document.getElementById("editProfileModal");
    modal.classList.remove("scale-100", "opacity-100");
    modal.classList.add("scale-95", "opacity-0");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.style.display = "none";
    }, 300);
  }
});












// ========== 💬 MENSAJES ==========

let activeSimpleChatUid = null;
let activeReceiverUid = null;
let unsubscribeSimpleChat = null; // 🧠 Muy importante

window.openSimpleMessagesModal = function () {
  const modal = document.getElementById("simpleMessagesModal");
  modal.classList.remove("hidden");
  modal.style.display = "flex";

  document.getElementById("simpleChatBox").classList.add("hidden");
  document.getElementById("simpleChatMessages").innerHTML = "";
  document.getElementById("simpleMessageInput").value = "";

  document.body.classList.add("overflow-hidden");

  loadSimpleFollowingList();
};

window.closeSimpleMessagesModal = function () {
  const modal = document.getElementById("simpleMessagesModal");
  modal.classList.add("hidden");
  modal.style.display = "none";

  document.getElementById("simpleChatBox").classList.add("hidden");
  document.getElementById("simpleChatMessages").innerHTML = "";
  document.getElementById("simpleMessageInput").value = "";

  if (typeof unsubscribeSimpleChat === "function") {
    unsubscribeSimpleChat();
    unsubscribeSimpleChat = null;
  }

  activeSimpleChatUid = null;
  activeReceiverUid = null;

  document.body.classList.remove("overflow-hidden");
};

async function loadSimpleFollowingList() {
  const user = auth.currentUser;
  const container = document.getElementById("simpleFollowingList");
  container.innerHTML = "";

  const seguidosSnap = await getDocs(collection(db, "usuarios", user.uid, "seguidos"));
  for (const docSnap of seguidosSnap.docs) {
    const followedUid = docSnap.id;
    const userSnap = await getDoc(doc(db, "usuarios", followedUid));
    if (!userSnap.exists()) continue;

    const userData = userSnap.data();

    const item = document.createElement("div");
    item.className = "flex items-center gap-3 cursor-pointer hover:bg-gray-100 p-2 rounded";
    item.innerHTML = `
      <img src="${userData.modalPhotoURL || userData.photoURL || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border" />
      <div>
        <div class="font-medium text-sm">${userData.name || "Usuario"}</div>
        <div class="text-xs text-gray-500">@${userData.username || "usuario"}</div>
      </div>
    `;
    item.onclick = () => openSimpleChatWithUser(followedUid, userData.name);
    container.appendChild(item);
  }
}

function openSimpleChatWithUser(otherUid, otherName) {
  const currentUid = auth.currentUser.uid;
  activeReceiverUid = otherUid;
  activeSimpleChatUid = [currentUid, otherUid].sort().join("_");

  document.getElementById("simpleChatBox").classList.remove("hidden");
  document.getElementById("simpleFollowingList").classList.add("hidden");

  document.getElementById("chatWithName").textContent = "Hablando con: " + otherName;

  const messagesRef = collection(db, "chats", activeSimpleChatUid, "messages");
  const q = query(messagesRef, orderBy("timestamp"));
  const container = document.getElementById("simpleChatMessages");
  container.innerHTML = "";

  // Cancela suscripción previa
  if (typeof unsubscribeSimpleChat === "function") {
    unsubscribeSimpleChat();
  }

  // 💡 SUSCRIPCIÓN A MENSAJES EN TIEMPO REAL
  unsubscribeSimpleChat = onSnapshot(q, (snapshot) => {
    container.innerHTML = "";

    snapshot.forEach((doc) => {
      const msg = doc.data();
      const isMine = msg.senderId === currentUid;

      const messageWrapper = document.createElement("div");
      messageWrapper.className = `flex mb-2 items-end ${isMine ? "justify-end" : "justify-start"}`;

      const bubbleWrapper = document.createElement("div");
      bubbleWrapper.className = "flex flex-col max-w-[70%]";

      const bubble = document.createElement("div");
      bubble.className = `px-4 py-2 rounded-xl text-sm shadow relative ${
        isMine
          ? "bg-blue-500 text-white rounded-br-none self-end"
          : "bg-gray-100 text-gray-900 rounded-bl-none self-start"
      }`;
      bubble.textContent = msg.text;

      bubble.setAttribute("unselectable", "on");
      bubble.style.userSelect = "none";
      bubble.style.webkitUserSelect = "none";
      bubble.style.msUserSelect = "none";

      const time = document.createElement("div");
      const date = msg.timestamp?.toDate();
      time.textContent = date
        ? date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        : "";
      time.className = `text-xs mt-1 ${
        isMine ? "text-right text-white/70" : "text-left text-gray-500"
      }`;

      const reactionBar = document.createElement("div");
      if (msg.reactions && Object.keys(msg.reactions).length > 0) {
        const uniqueEmojis = [...new Set(Object.values(msg.reactions))];
        reactionBar.textContent = uniqueEmojis.join(" ");
        reactionBar.className = `text-sm mt-1 ${
          isMine ? "text-right text-white/80" : "text-left text-gray-600"
        }`;
      } else {
        reactionBar.textContent = "";
        reactionBar.className = "min-h-[1.5em]";
      }

      let pressTimer;

      // 📱 Lógica para mantener pulsado o doble clic para reaccionar
      const setupReactionEvents = () => {
        bubble.addEventListener("mousedown", (e) => {
          if (e.target !== bubble) return;
          pressTimer = setTimeout(() => showReactionMenu(msg, doc.id, reactionBar, e), 500);
        });
        bubble.addEventListener("mouseup", () => clearTimeout(pressTimer));
        bubble.addEventListener("mouseleave", () => clearTimeout(pressTimer));
        bubble.addEventListener("dblclick", (e) => {
          if (e.target !== bubble) return;
          showReactionMenu(msg, doc.id, reactionBar, e);
        });

        bubble.addEventListener("touchstart", (e) => {
          if (e.target !== bubble) return;
          e.preventDefault();
          pressTimer = setTimeout(
            () => showReactionMenu(msg, doc.id, reactionBar, e.touches[0]),
            500
          );
        });
        bubble.addEventListener("touchend", () => clearTimeout(pressTimer));
        bubble.addEventListener("touchcancel", () => clearTimeout(pressTimer));
      };

      setupReactionEvents();

      bubbleWrapper.appendChild(bubble);
      bubbleWrapper.appendChild(reactionBar);
      bubbleWrapper.appendChild(time);

      if (isMine) {
        messageWrapper.appendChild(bubbleWrapper);
      } else {
        const avatar = document.createElement("img");
        avatar.src = msg.senderPhoto || "https://via.placeholder.com/32";
        avatar.className = "w-6 h-6 rounded-full mr-2 border";
        messageWrapper.appendChild(avatar);
        messageWrapper.appendChild(bubbleWrapper);
      }

      container.appendChild(messageWrapper);
    });

    container.scrollTop = container.scrollHeight;
  });
}

window.sendSimpleMessage = async function () {
  const input = document.getElementById("simpleMessageInput");
  const text = input.value.trim();

  if (!text) return;
  if (!activeSimpleChatUid || !activeReceiverUid) return;

  const currentUid = auth.currentUser.uid;

  try {
    const chatRef = doc(db, "chats", activeSimpleChatUid);
    const messageRef = collection(chatRef, "messages");

    await setDoc(chatRef, {
      users: [currentUid, activeReceiverUid],
      lastMessage: text,
      lastUpdated: serverTimestamp()
    }, { merge: true });

    await addDoc(messageRef, {
      text,
      senderId: currentUid,
      senderPhoto: auth.currentUser.photoURL || null,
      timestamp: serverTimestamp(),
      reactions: {}
    });

    input.value = "";
  } catch (error) {
    console.error("Error al enviar mensaje:", error);
  }
};

window.showReactionMenu = async function (msg, messageId, container, event) {
  if (!activeSimpleChatUid || !auth.currentUser?.uid) return;

  document.querySelectorAll('.emoji-menu').forEach(el => el.remove());

  const menu = document.createElement("div");
  menu.className = "emoji-menu";
  Object.assign(menu.style, {
    position: "fixed",
    zIndex: 10000,
    background: "white",
    padding: "8px",
    borderRadius: "12px",
    display: "flex",
    gap: "4px"
  });

  const x = event.clientX || event.touches?.[0]?.clientX;
  const y = event.clientY || event.touches?.[0]?.clientY;
  menu.style.left = `${Math.max(10, x - 120)}px`;
  menu.style.top = `${Math.max(10, y - 60)}px`;

  ["❤️", "😂", "👍", "🔥", "😮", "😢"].forEach(emoji => {
    const btn = document.createElement("button");
    btn.textContent = emoji;
    btn.onclick = async (e) => {
      e.stopPropagation();
      try {
        await updateDoc(doc(db, "chats", activeSimpleChatUid, "messages", messageId), {
          [`reactions.${auth.currentUser.uid}`]: emoji
        });
      } catch (error) {
        console.error("Error al guardar reacción:", error);
      }
      menu.remove();
    };
    menu.appendChild(btn);
  });

  document.body.appendChild(menu);

  const closeMenu = (e) => !menu.contains(e.target) && menu.remove();
  document.addEventListener("click", closeMenu, { once: true });
};

















// ========== 🔐 AUTENTICACIÓN ==========
// login, logout, detectar sesión

// ... código de autenticación ...

// ========== 🧑 PERFIL ==========
// cargar perfil, editar, mostrar modal

// ... código de perfil ...

// ========== 📝 PUBLICACIONES ==========
// crear post, renderizar, escuchar en tiempo real

// ... código de publicaciones ...

// ========== 💬 MENSAJES ==========
// abrir chat, enviar, recibir mensajes

// ... código de mensajes ...

// ========== 👥 SEGUIDORES ==========
// seguir, dejar de seguir, contadores

// ... código de seguidores ...



// ========== 🛒 PUBLICACIÓN DE PRODUCTOS ==========
if (!window.__MODULO_PUBLICACION_PRODUCTOS_ACTIVO) {
  window.__MODULO_PUBLICACION_PRODUCTOS_ACTIVO = true;

  document.addEventListener('DOMContentLoaded', function () {
    // Variables globales
    let activePostId = "";
    const auth = getAuth();
    const db = getFirestore();


    // Configuración inicial
    const venderBtn = document.getElementById('venderBtn');
    const sellerPostModal = document.getElementById('sellerPostModal');
    
    if (venderBtn && sellerPostModal) {
      venderBtn.addEventListener('click', () => {
        sellerPostModal.classList.remove('hidden');
        sellerPostModal.classList.add('flex');
      });

      window.closeSellerPostModal = function() {
        sellerPostModal.classList.add('hidden');
        sellerPostModal.classList.remove('flex');
      };
    }


    // Función para publicar producto
window.publicarProducto = async function () {
  const btn = document.getElementById("publicarProductoBtn");
  if (!btn) return;

  btn.disabled = true;

  // Preparar textos y spinner (en caso de que los uses)
  const btnText = btn.querySelector(".btn-text");
  const spinner = btn.querySelector(".spinner");
  if (btnText) btnText.textContent = "Publicando...";
  if (spinner) spinner.classList.remove("hidden");

  try {
    const titulo = document.getElementById('productTitle').value.trim();
    const descripcion = document.getElementById('productDescription').value.trim();
    const precio = document.getElementById('productPrice').value.trim();
    const codigoPais = document.getElementById('codigoPais').value.trim();
    const numero = document.getElementById('productWhatsapp').value.trim();
    const imagenFile = document.getElementById('productImage').files[0];

    if (!titulo || !descripcion || !precio || !codigoPais || !numero || !imagenFile) {
      throw new Error('Completa todos los campos, incluido el número de WhatsApp.');
    }

    const whatsappCompleto = `${codigoPais}${numero}`;
    const whatsappRegex = /^\+\d{1,4}\d{6,14}$/; // Ej: +573001234567

    if (!whatsappRegex.test(whatsappCompleto)) {
      throw new Error('Por favor, ingresa un número de WhatsApp válido con código de país (Ej: +57...).');
    }

    const user = auth.currentUser;
    if (!user) throw new Error('Debes iniciar sesión primero.');

    const mediaURL = await uploadMediaToCloudinary(imagenFile);

    await addDoc(collection(db, "posts"), {
      tipo: "venta",
      titulo,
      descripcion,
      precio,
      whatsapp: whatsappCompleto,
      imagen: mediaURL,
      isVideo: imagenFile.type.startsWith('video/'),
      username: user.displayName || "Usuario",
      photoURL: user.photoURL || "https://via.placeholder.com/40",
      uid: user.uid,
      timestamp: serverTimestamp()
    });

    // Limpiar campos
    ['productTitle', 'productDescription', 'productPrice', 'codigoPais', 'productWhatsapp'].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById('productImage').value = "";

    closeSellerPostModal();
    alert("✅ Producto publicado exitosamente.");
  } catch (error) {
    console.error("❌ Error al publicar:", error);
    alert(error.message);
  } finally {
    btn.disabled = false;
    if (btnText) btnText.textContent = "Publicar producto";
    if (spinner) spinner.classList.add("hidden");
  }
};




    // Escuchar posts en tiempo real
    function listenForPosts() {
      const postsContainer = document.getElementById("postsContainer");
      if (!postsContainer) return;

      const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        postsContainer.innerHTML = "";
        snapshot.forEach((doc) => {
          postsContainer.insertAdjacentHTML('beforeend',
            renderPostHTML(doc.data(), {}, doc.id)
          );
        });
      }, (error) => {
        console.error("Error en snapshot:", error);
      });
    }







    // Manejadores de eventos unificados
    document.addEventListener('click', async function(e) {
      const clicked = e.target;
      
      // Manejo de medios
      if (clicked.classList.contains('media-clickable')) {
        handleMediaClick(clicked);
        return;
      }

      // Manejo de comentarios en modal
      if (clicked.classList.contains('show-comments-btn')) {
        activePostId = clicked.getAttribute('data-post-id');
        openCommentsModal(activePostId);
        return;
      }

      if (clicked.id === 'modalSendCommentBtn') {
        await handleCommentSubmission(true);
        return;
      }

      // Manejo de comentarios en post
      const sendBtn = e.target.closest(".comment-submit");
      const toggleBtn = e.target.closest(".toggle-comments-btn");

      if (toggleBtn) {
        toggleCommentsSection(toggleBtn);
        return;
      }

      if (sendBtn) {
        await handleCommentSubmission(false, sendBtn);
      }
    });

    // Funciones auxiliares
    async function uploadMediaToCloudinary(file) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'Tweetsocial');

      const uploadURL = file.type.startsWith('video/')
        ? "https://api.cloudinary.com/v1_1/dz70korgo/video/upload"
        : "https://api.cloudinary.com/v1_1/dz70korgo/image/upload";

      const response = await fetch(uploadURL, { method: "POST", body: formData });
      const data = await response.json();
      
      if (!data.secure_url) throw new Error("Error al subir a Cloudinary");
      return data.secure_url;
    }

    function handleMediaClick(element) {
      const src = element.src;
      const isVideo = element.tagName.toLowerCase() === 'video';
      const mediaContainer = document.getElementById('mediaContainer');
      
      mediaContainer.innerHTML = isVideo
        ? `<video controls autoplay class="max-w-full max-h-screen rounded shadow"><source src="${src}" type="video/mp4"></video>`
        : `<img src="${src}" class="max-w-full max-h-screen rounded shadow" alt="Media">`;
      
      document.getElementById('mediaModal').classList.remove('hidden');
    }

    function openCommentsModal(postId) {
      document.getElementById('commentsModal').classList.remove('hidden');
      document.getElementById('commentsModal').classList.add('flex');
      loadComments(postId, document.getElementById('commentsModalContent'));
    }

    async function toggleCommentsSection(button) {
      const post = button.closest(".post");
      const section = post.querySelector(".comments-section");
      section.classList.toggle("hidden");

      if (!section.classList.contains("hidden")) {
        await loadComments(
          post.dataset.postId, 
          section.querySelector(".comments-list")
        );
      }
    }

    async function handleCommentSubmission(isModal, button = null) {
      const input = isModal 
        ? document.getElementById('modalCommentInput')
        : button?.closest(".post")?.querySelector(".comment-input");
      
      const text = input?.value.trim();
      if (!text) return alert("Escribe un comentario");

      const user = auth.currentUser;
      if (!user) return alert("Debes iniciar sesión");

      const postId = isModal 
        ? activePostId 
        : button?.closest(".post")?.dataset.postId;
      
      if (!postId) return;

      try {
        await addDoc(collection(db, "posts", postId, "comentarios"), {
          text,
          uid: user.uid,
          username: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40",
          timestamp: serverTimestamp()
        });

        input.value = "";
        
        if (isModal) {
          loadComments(postId, document.getElementById('commentsModalContent'));
        } else {
          const section = button.closest(".post")?.querySelector(".comments-section");
          if (section && !section.classList.contains("hidden")) {
            await loadComments(postId, section.querySelector(".comments-list"));
          }
        }
      } catch (error) {
        console.error("Error al publicar comentario:", error);
        alert("Error al publicar comentario");
      }
    }

    async function loadComments(postId, container) {
      if (!container) return;
      
      container.innerHTML = "<span class='text-sm text-gray-400'>Cargando...</span>";

      try {
        const snap = await getDocs(query(
          collection(db, "posts", postId, "comentarios"),
          orderBy("timestamp", "asc")
        ));

        container.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          container.innerHTML += `
            <div class="flex items-start gap-2 text-sm mb-1">
              <img src="${data.photoURL}" class="w-6 h-6 rounded-full" />
              <div>
                <span class="font-semibold">@${data.username}</span>
                <p>${data.text}</p>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error("Error cargando comentarios:", error);
        container.innerHTML = "<span class='text-sm text-red-500'>Error cargando comentarios</span>";
      }
    }



// ========== 🌐 FUNCIÓN PARA COMPARTIR POSTS ==========
window.sharePost = async function(postId) {
  const shareBtn = document.querySelector(`[onclick="sharePost('${postId}')]`);
  const btnText = shareBtn?.querySelector('span');
  const originalText = btnText?.textContent;
  
  if (shareBtn) {
    shareBtn.disabled = true;
    if (btnText) btnText.textContent = "Compartiendo...";
    shareBtn.classList.add('opacity-75');
  }

  try {
    const db = getFirestore();
    const postRef = doc(db, "posts", postId);
    const postSnap = await getDoc(postRef);
    
    if (!postSnap.exists()) {
      showToast('error', 'La publicación no existe o fue eliminada');
      return;
    }

    const postData = postSnap.data();
    const shareUrl = `${window.location.origin}/post/${postId}`;

    const shareData = {
      title: postData.tipo === "venta" 
        ? `🛍️ ${postData.titulo || "Producto sin título"}` 
        : "📢 Mira esta publicación",
      text: postData.tipo === "venta"
        ? `${postData.descripcion || ""}\n💰 Precio: $${postData.precio || 0}`
        : postData.text || "",
      url: shareUrl
    };

    if (navigator.share) {
      // Compartir solo texto + URL (sin imágenes)
      await navigator.share(shareData);
    } else {
      const shareText = `${shareData.title}\n${shareData.text}\n\n🔗 ${shareData.url}`;
      
      if (navigator.clipboard) {
        await navigator.clipboard.writeText(shareText);
        showToast('success', '¡Enlace copiado al portapapeles!');
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = shareText;
        textarea.style.position = 'fixed';
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
          document.execCommand('copy');
          showToast('success', 'Enlace copiado');
        } catch (execError) {
          window.open(`mailto:?subject=${encodeURIComponent(shareData.title)}&body=${encodeURIComponent(shareText)}`, '_blank');
        }

        document.body.removeChild(textarea);
      }
    }

  } catch (error) {
    if (error.name !== 'AbortError') {
      console.error("Error al compartir:", error);
      showToast('error', `Error al compartir: ${error.message}`);
    }
  } finally {
    if (shareBtn) {
      shareBtn.disabled = false;
      if (btnText) btnText.textContent = originalText;
      shareBtn.classList.remove('opacity-75');
    }
  }
};

// Función auxiliar para mostrar notificaciones
function showToast(type, message) {
  alert(message); // Usa tu propio sistema si tienes uno
}


    // Funciones para cerrar modales
    window.closeMediaModal = function() {
      document.getElementById('mediaModal').classList.add('hidden');
      document.getElementById('mediaContainer').innerHTML = "";
    };

    window.closeCommentsModal = function() {
      document.getElementById('commentsModal').classList.add('hidden');
      document.getElementById('commentsModal').classList.remove('flex');
      document.getElementById('commentsModalContent').innerHTML = "";
      activePostId = "";
    };



// 🔙 Botón para volver a la lista de contactos desde el chat
    const backBtn = document.getElementById('backToContacts');
    if (backBtn) {
      backBtn.addEventListener('click', function () {
        const chatBox = document.getElementById('simpleChatBox');
        const contactList = document.getElementById('simpleFollowingList');

        chatBox.classList.add('hidden');
        contactList.classList.remove('hidden');
      });
    }



const toggleButton = document.getElementById("theme-toggle");

// Cargar la preferencia del usuario
const currentTheme = localStorage.getItem("theme");
if (currentTheme) {
    document.body.classList.add(currentTheme);
}

// Cambiar el tema
toggleButton.addEventListener("click", () => {
    document.body.classList.toggle("dark-mode");
    // Guardar la preferencia del usuario
    if (document.body.classList.contains("dark-mode")) {
        localStorage.setItem("theme", "dark-mode");
    } else {
        localStorage.setItem("theme", "");
    }
});








    // Iniciar
    listenForPosts();
  });
}





















// Script para el sidebar deslizable mejorado
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const mainContent = document.getElementById('mainContent');
        let isCollapsed = false;

        toggleBtn.addEventListener('click', () => {
            isCollapsed = !isCollapsed;

            if(isCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
                toggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                `;
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                toggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                `;
            }
        });

        // (El resto de tus scripts aquí)






















// Manejo de Interacciones Móviles y Perfil
document.getElementById("mobileEditBtn").addEventListener("click", () => {
  document.getElementById("openEditProfileFromModal").click();
});

document.getElementById("mobileCrearBtn").addEventListener("click", () => {
  document.getElementById("crearPublicacionBtn").click();
});

document.getElementById("mobileVenderBtn").addEventListener("click", () => {
  document.getElementById("venderBtn").click();
});

// Adaptamos el botón de perfil en móvil (mismo comportamiento que loginBtn)
document.getElementById("loginBtnMobile").addEventListener("click", () => {
  document.getElementById("loginBtn").click();
});

// Función que simula el login y actualiza ambos perfiles
function mostrarPerfil(nombreUsuario, fotoUrl) {
  // Mostrar en PC
  document.getElementById("loginBtn").classList.add("hidden");
  document.getElementById("profileContainerSidebar").classList.remove("hidden");
  document.getElementById("usernameSidebar").innerText = nombreUsuario;
  document.getElementById("profilePicSidebar").src = fotoUrl;
  // Mostrar en móvil
  document.getElementById("loginBtnMobile").classList.add("hidden");
  document.getElementById("profileContainerMobile").classList.remove("hidden");
  document.getElementById("profilePicMobile").src = fotoUrl;
}

// Simulación: ya estabas logueado
// mostrarPerfil("Carlos", "https://i.pravatar.cc/100");




















</script>
</body>
</html>
