<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>

/* Estilos del contenedor de perfil */
#profileContainer {
document.getElementById("openEditProfileFromModal").addEventListener("click", function () {
    // Cerrar el modal del perfil
    closeModal();

    // Abrir el modal de edición de perfil
    openEditProfileModal();
});
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ddd; /* Color para visualizar */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

#profileContainer img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}



.modal {
    display: none;
    position: fixed;
    inset: 0;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
}

.hidden {
    display: none !important;
}

.scale-100 {
    transform: scale(1);
    opacity: 1;
}

.scale-95 {
    transform: scale(0.95);
    opacity: 0;
}

#profileContainer {
    display: none;
}






/* Estilos para la transición del sidebar */
        .sidebar-collapsed .sidebar-text {
            opacity: 0;
            width: 0;
            margin-left: 0;
            margin-right: 0;
            position: absolute;
        }
        
        .sidebar-collapsed .sidebar-icon {
            font-size: 1.5rem;
            margin: 0 auto;
        }
        
        .sidebar-collapsed {
            width: 5rem !important;
        }
        
        .sidebar-collapsed .sidebar-content {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        .sidebar-collapsed #mainContent {
            margin-left: 5rem;
        }












</style>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen bg-gray-50">
        <!-- Sidebar deslizable mejorado -->
        <aside id="sidebar" class="bg-white shadow-md sticky top-0 h-screen overflow-y-auto transition-all duration-300 ease-in-out w-64">
            <!-- Botón para contraer/expandir -->
            <button id="toggleSidebar" class="absolute -right-3 top-5 bg-white rounded-full shadow-md p-1 z-10 hover:bg-gray-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>

            <!-- Contenido del sidebar -->
            <div class="p-5 sidebar-content">
                <!-- Logo/Brand con transición -->
                <div class="mb-8 flex items-center transition-all duration-300">
                    <h1 class="text-2xl font-bold text-blue-600 whitespace-nowrap sidebar-text">SocialApp</h1>
                </div>

                <!-- Contenedor de Login / Perfil -->
                <div id="authContainer" class="mb-6">
                    <button id="loginBtn" class="w-full flex items-center justify-center overflow-hidden bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg mb-4 transition duration-200">
                        <span class="sidebar-icon">👤</span>
                        <span class="sidebar-text ml-2">Iniciar sesión</span>
                    </button>

                    <!-- Contenedor del perfil -->
                    <div id="profileContainerSidebar" class="hidden flex items-center p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition">
                        <img id="profilePicSidebar" src="https://via.placeholder.com/50" alt="Perfil" class="w-10 h-10 rounded-full object-cover">
                        <span id="usernameSidebar" class="font-medium whitespace-nowrap sidebar-text ml-3">Usuario</span>
                    </div>
                </div>

                <!-- Menú de navegación -->
                <nav class="mb-6">
                    <ul class="space-y-2">
                        <li>
                            <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                                <span class="sidebar-icon">📦</span>
                                <span class="sidebar-text ml-3">Pedidos</span>
                                <span class="ml-auto bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full sidebar-text">5</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                                <span class="sidebar-icon">🔔</span>
                                <span class="sidebar-text ml-3">NotifixD</span>
                                <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">3</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                                <span class="sidebar-icon">💬</span>
                                <span class="sidebar-text ml-3">Chats</span>
                            </a>
                        </li>
                        <li>
                            <button id="editProfileBtn" class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                                <span class="sidebar-icon">⚙️</span>
                                <span class="sidebar-text ml-3">Editar</span>
                            </button>
                        </li>
                    </ul>
                </nav>

                <!-- Botones -->
                <button id="crearPublicacionBtn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg mt-4 transition duration-200 shadow-md">
                    <span class="sidebar-icon">+</span>
                    <span class="sidebar-text ml-2">Crear</span>
                </button>
                <button id="venderBtn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded-lg mt-2 transition duration-200 shadow-md">
                    <span class="sidebar-icon">🛒</span>
                    <span class="sidebar-text ml-2">Vender</span>
                </button>
            </div>
        </aside>

        
    <!-- Main Content -->
    <main class="flex-1 p-6 max-w-2xl mx-auto">
  <!-- Creador de publicaciones -->
  <div class="bg-white p-5 rounded-xl shadow-md mb-6">
    <textarea id="postInput" placeholder="¿Qué necesitas?"
      rows="3"
      class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>

    <div class="flex items-center justify-between mb-3">
      <div>
        <label for="postImageInput" class="cursor-pointer text-gray-600 hover:text-blue-600 transition">
          📷 Foto/Video
        </label>
        <input id="postImageInput" type="file" accept="image/*,video/*" class="hidden">
      </div>
      <span id="fileInfo" class="text-sm text-gray-500 truncate max-w-xs"></span>
    </div>

    <button id="publishBtn" disabled
      class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition">
      Publicar
    </button>
  </div>

  <!-- Contenedor de publicaciones -->
  <div id="postsContainer" class="space-y-4"></div>
</main>





    <!-- Modal de Login -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative">
            <h2 class="text-xl font-bold mb-4">Bienvenido</h2>
            <p class="text-gray-600 mb-4">Elige una opción para continuar</p>

            <!-- Botón para iniciar sesión como vendedor -->
            <button id="sellerLoginBtn" class="w-full flex items-center justify-center bg-blue-600 text-white p-2 rounded mb-2">
                <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="w-6 h-6 mr-2">
                Continuar para vendedores
            </button>

            <!-- Botón para iniciar sesión con Google -->
            <button id="googleLoginBtn" class="w-full flex items-center justify-center bg-red-600 text-white p-2 rounded">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-2">
                Continuar con Google
            </button>

            <!-- Botón para cerrar el modal -->
            <button id="closeModal" class="absolute top-2 right-2 text-gray-600 text-xl">&times;</button>
        </div>
    </div>

    <!-- Contenedor del perfil -->
    <div id="profileContainer" class="hidden flex items-center space-x-2 cursor-pointer">
        <img id="profilePic" src="https://via.placeholder.com/40" alt="Perfil" class="w-10 h-10 rounded-full">
        <span id="profileName" class="font-semibold"></span>
    </div>

    
    <!-- MODAL PARA EDITAR PERFIL -->
<div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative">
    <button id="closeEditProfileModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">Editar Perfil</h2>

    <!-- Imagen de Perfil -->
    <img id="editProfilePic" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full mx-auto mb-3">

    <!-- Input para cambiar nombre -->
    <input id="editProfileName" type="text" class="border p-2 w-full rounded mb-4" placeholder="Nuevo nombre">

    <!-- NUEVOS CAMPOS: Nombre de usuario y biografía -->
    <input id="editProfileUsername" type="text" class="border p-2 w-full rounded mb-4" placeholder="Nombre de usuario (ej. @charly)">
    <textarea id="editProfileBio" class="border p-2 w-full rounded mb-4" rows="3" placeholder="Biografía del usuario..."></textarea>

    <!-- Botón para guardar cambios -->
    <button id="saveProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2 w-full">Guardar cambios</button>

    <!-- 🔄 Botón para cambiar a cuenta de vendedor -->
    <button id="switchToSellerBtn" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2 w-full">Cambiar a cuenta de vendedor</button>

    <!-- Botón para cerrar sesión -->
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded w-full">Cerrar sesión</button>
  </div>
</div>

   

   <!-- MODAL DEL PERFIL -->
<div id="profileModal" class="modal hidden fixed inset-0 flex items-center justify-center z-50">
    <!-- Fondo oscuro difuminado -->
    <div id="modalOverlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md"></div>

    <!-- Contenido del modal -->
    <div id="modalContent" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative transform scale-95 opacity-0 transition-all duration-300 ease-in-out">

        <!-- Botón de cerrar -->
        <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-600 text-2xl hover:text-gray-800">
            &times;
        </button>

        <!-- Foto de perfil con opción de cambio -->
        <label for="profilePicInput" class="cursor-pointer block">
            <img id="profilePicModal" src="https://via.placeholder.com/80" class="w-24 h-24 rounded-full mx-auto mb-3 border-2 border-gray-300">
        </label>
        <input type="file" id="profilePicInput" accept="image/*" class="hidden">
        <button id="saveProfilePicBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition mt-2 hidden">
            Guardar Foto
        </button>

        <!-- Nombre y biografía -->
        <h2 class="text-xl font-bold text-gray-900" id="modalProfileName">Owen</h2>
        <p id="modalProfileUsername" class="text-gray-600">@charly</p>
        <p id="modalProfileBio" class="text-gray-500 text-sm mb-4">Esta es la biografía del usuario.</p>

        <!-- Botón de editar perfil -->
        <button id="openEditProfileFromModal" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition">
            Editar perfil
        </button>
         
         <button id="followBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition hidden">
             Seguir
         </button>



        <!-- Información del usuario -->
        <div class="flex justify-around text-gray-700 text-sm mt-3">
            <span><b id="profilePostCount">0</b> Publicaciones</span>
            <span><b id="profileFollowingCount">0</b> Siguiendo</span>
            <span><b id="profileFollowersCount">0</b> Seguidores</span>
         </div>
         
        <!-- Timeline -->
        <h3 class="mt-4 font-bold text-gray-800">Timeline</h3>
        <div class="bg-gray-100 p-2 rounded mt-2 shadow-sm">Primer Publicación</div>
        <div class="bg-gray-100 p-2 rounded mt-2 shadow-sm">Segunda Publicación</div>
    </div>
</div>





    <!-- MODAL PARA VENDEDORES -->
<div id="sellerProfileModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div id="sellerModalContent" class="bg-white p-6 rounded-lg shadow-lg text-center w-[500px] relative">

    <!-- Botón de cerrar -->
    <button id="closeSellerModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">
      &times;
    </button>

    <!-- Imagen de perfil -->
    <img id="sellerProfilePic" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full mx-auto mb-2" />

    <h2 id="sellerName" class="text-xl font-bold">Nombre del Vendedor</h2>
    <p id="sellerUsername" class="text-gray-600">@usuario</p>
    <p id="sellerBio" class="text-gray-500 text-sm mb-4">Biografía del vendedor.</p>

    <!-- Botones funcionales -->
    <button id="openOrdersModal" class="bg-green-500 text-white px-4 py-2 rounded mb-2 w-full">📦 Ver pedidos</button>
    <button id="openEarningsModal" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2 w-full">💰 Gestionar ingresos</button>
    <button id="editSellerProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2 w-full">✏ Editar perfil</button>

    <!-- Estadísticas -->
    <div class="flex justify-around text-gray-700 text-sm mt-3">
      <span><b id="sellerTweets">0</b> Publicaciones</span>
      <span><b id="sellerFollowing">0</b> Siguiendo</span>
      <span><b id="sellerFollowers">0</b> Seguidores</span>
    </div>

    <!-- Historial -->
    <h3 class="mt-4 font-bold text-gray-800">Historial de Ventas</h3>
    <div class="bg-gray-100 p-2 rounded mt-2">Último Pedido</div>
    <div class="bg-gray-100 p-2 rounded mt-2">Producto Más Vendido</div>
  </div>
</div>


<!-- MODAL: Ver Pedidos -->
<div id="ordersModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeOrdersModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">📦 Tus Pedidos</h2>
    <div class="text-sm text-gray-600">
      <p>Aquí aparecerán los pedidos realizados por tus compradores.</p>
    </div>
  </div>
</div>

<!-- MODAL: Gestionar Ingresos -->
<div id="earningsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeEarningsModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">💰 Gestionar Ingresos</h2>
    <div class="text-sm text-gray-600">
      <p>Resumen de tus ingresos y opciones para retirar fondos.</p>
    </div>
  </div>
</div>


<!-- Modal de imagen de perfil -->
<div id="profilePicPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="w-40 h-40 rounded-full overflow-hidden border-4 border-white shadow-lg">
    <img id="previewProfilePic" src="" class="w-full h-full object-cover" />
  </div>
</div>




















<!-- Modal de Mensajes Simple -->
<div id="simpleMessagesModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden" style="display: none;">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-4 space-y-4">

    <div class="flex justify-between items-center border-b pb-2">
      <h2 class="text-lg font-bold">💬 Hablar con alguien</h2>
      <button onclick="closeSimpleMessagesModal()" class="text-xl">&times;</button>
    </div>

    <!-- Lista de usuarios que sigues -->
    <div id="simpleFollowingList" class="space-y-3 max-h-64 overflow-y-auto">
      <!-- Aquí se cargan los usuarios seguidos -->
    </div>

    <!-- Chat básico -->
    <div id="simpleChatBox" class="hidden space-y-2">
      <div class="text-sm text-gray-700 font-medium" id="chatWithName">Hablando con:</div>
      <div id="simpleChatMessages" class="h-40 overflow-y-auto bg-gray-50 rounded p-2 text-sm border"></div>

      <div class="flex gap-2">
        <input type="text" id="simpleMessageInput" class="flex-1 border rounded px-3 py-1 text-sm" placeholder="Escribe un mensaje...">
        <button onclick="sendSimpleMessage()" class="bg-indigo-500 text-white px-4 py-1 rounded text-sm">Enviar</button>
      </div>
    </div>

  </div>
</div>

<!-- Botón para abrir el modal -->
<button onclick="openSimpleMessagesModal()" class="fixed bottom-6 right-6 bg-indigo-500 text-white px-4 py-2 rounded-full shadow-lg hover:bg-indigo-600 transition">
  💬 Mensajes
</button>












                                                                                                            


                                                                                                            
<!-- ✅ Modal para publicaciones de vendedor -->
<div id="sellerPostModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white w-full max-w-md mx-auto mt-10 rounded-2xl p-6 shadow-lg relative flex flex-col">
    <h2 class="text-xl font-semibold mb-4 text-center text-gray-800">🛍️ Publicar producto</h2>

    <!-- Título -->
    <input
      id="productTitle"
      type="text"
      placeholder="Título del producto"
      class="w-full border border-gray-300 rounded-lg p-2 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />

    <!-- Descripción -->
    <textarea
      id="productDescription"
      placeholder="Descripción del producto"
      class="w-full border border-gray-300 rounded-lg p-2 mb-3 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
    ></textarea>

    <!-- Precio -->
    <input
      id="productPrice"
      type="number"
      placeholder="Precio (ej: 199.99)"
      class="w-full border border-gray-300 rounded-lg p-2 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />

    <!-- Imagen o video -->
    <input
      id="productImage"
      type="file"
      accept="image/*,video/*"
      class="w-full mb-4"
    />

    <!-- Botones -->
    <div class="flex justify-between items-center mt-2">
      <!-- Cancelar -->
      <button
        onclick="closeSellerPostModal()"
        class="text-sm text-gray-500 hover:text-gray-700 transition"
      >
        Cancelar
      </button>

      <!-- Publicar -->
      <button
        id="publicarProductoBtn"
        onclick="publicarProducto()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition"
      >
        Publicar
      </button>
    </div>
  </div>
</div>









<div id="mediaModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center hidden z-50">
  <button onclick="closeMediaModal()" class="absolute top-4 right-4 text-white text-2xl">&times;</button>
  <div id="mediaContainer" class="max-w-full max-h-full p-4">
    <!-- Aquí aparecerá la imagen o video -->
  </div>
</div>




<!-- Comentarios Modal -->
<div id="commentsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white p-4 rounded shadow max-w-md w-full">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-lg font-bold">Comentarios</h3>
      <button onclick="closeCommentsModal()">✖</button>
    </div>
    <div id="commentsModalContent" class="max-h-64 overflow-y-auto mb-2"></div>
    <div class="flex space-x-2">
      <input id="modalCommentInput" class="border rounded w-full p-1" placeholder="Escribe un comentario...">
      <button id="modalSendCommentBtn" class="bg-blue-500 text-white px-3 rounded">Enviar</button>
    </div>
  </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

  import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    getDocs,           // ✅ Necesario para contar documentos (posts, seguidores, etc.)
    addDoc,
    deleteDoc,         // ✅ Para dejar de seguir
    serverTimestamp,
    query,
    where,             // ✅ Para filtrar por UID en posts
    orderBy,
    onSnapshot,
    collection,
    updateDoc        // ✅ Añadido para actualizar documentos
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Aquí continúa el resto de tu script...


		
  // 🔥 Configuración de Firebase actualizada
  const firebaseConfig = {
    apiKey: "AIzaSyAwNDRXI62gadPrDls9AkNnjtTijgyeJ8w",
    authDomain: "tweetsocial.firebaseapp.com",
    projectId: "tweetsocial",
    storageBucket: "tweetsocial.firebasestorage.app",
    messagingSenderId: "84273856654",
    appId: "1:84273856654:web:1ce541725d2b48781709df",
    measurementId: "G-PQSEFMQ32K"
  };

  // 🚀 Inicializar Firebase con configuración correcta
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();






    const profilePicInput = document.getElementById("profilePicInput");
    const saveProfilePicBtn = document.getElementById("saveProfilePicBtn");
    const profilePicModal = document.getElementById("profilePicModal");

    profilePicInput.addEventListener("change", function () {
    const file = profilePicInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            profilePicModal.src = e.target.result; // Vista previa de la imagen
        };
        reader.readAsDataURL(file);
        saveProfilePicBtn.classList.remove("hidden"); // Muestra el botón de guardar
    }
});

     
   saveProfilePicBtn.addEventListener("click", async function () {
    const user = auth.currentUser;
    if (!user || !profilePicInput.files.length) {
        alert("❌ No hay usuario autenticado o no se seleccionó una imagen.");
        return;
    }

    const file = profilePicInput.files[0];
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "Tweetsocial"); // 🔹 Cambia esto por el nuevo preset que configuraste

    try {
        alert("📤 Subiendo imagen a Cloudinary...");
        const response = await fetch("https://api.cloudinary.com/v1_1/dz70korgo/image/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        // 🚨 Verificar si la respuesta de Cloudinary es válida
        if (!data.secure_url) {
            throw new Error("No se recibió una URL válida de Cloudinary.");
        }

        const photoURL = data.secure_url;
        alert("✅ Imagen subida correctamente. URL: " + photoURL);

        // Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, { modalPhotoURL: photoURL }, { merge: true });

        alert("✅ modalPhotoURL guardado en Firestore: " + photoURL);

        // ✅ Actualizar la UI en ambos modales
        document.getElementById("profilePicModal").src = photoURL;
        document.getElementById("editProfilePic").src = photoURL; // <--- 🔥 ESTA ES LA LÍNEA NUEVA

        saveProfilePicBtn.classList.add("hidden");

    } catch (error) {
        alert("❌ Error al subir la imagen: " + error.message);
        console.error("Error detallado:", error);
    }
});


    // 📌 Función para iniciar sesión con Google
    
    // 📌 Función para iniciar sesión con Google
async function login() {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        console.log("✅ Usuario autenticado:", user);

        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            await setDoc(userRef, {
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                accountType: "google",
                username: user.email.split("@")[0],
                bio: ""
            });
            alert("✅ Usuario nuevo registrado en Firestore");
        } else {
            alert("ℹ️ Usuario ya existía en Firestore");
        }

        // ✅ Cerrar el modal de bienvenida
        document.getElementById("loginModal")?.classList.add("hidden");

        await loadUserProfile(user.uid);
        closeModal();

    } catch (error) {
        alert("❌ Error en login: " + error.message);
        console.error("❌ Error en login:", error);
    }
}


    // 📌 Función para iniciar sesión como vendedor
    async function loginAsSeller() {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    console.log("✅ Usuario autenticado como vendedor:", user);

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        accountType: "seller"
      });
    } else {
      await setDoc(userRef, { accountType: "seller" }, { merge: true });
    }

    // ✅ Cerrar modal de bienvenida
    document.getElementById("loginModal")?.classList.add("hidden");

    // ✅ Cerrar otros modales
    closeModal();

    // ✅ Cargar y sincronizar datos del perfil
    await loadUserProfile(user.uid);
    await syncAccountTypeUI(user); // 🔥 ACTUALIZA EL MODAL DE VENDEDOR

    // ✅ Mostrar el modal de vendedor directamente
    const sellerModal = document.getElementById("sellerProfileModal");
    if (sellerModal) {
      sellerModal.classList.remove("hidden");
      sellerModal.style.display = "flex";
    }

  } catch (error) {
    console.error("❌ Error en login como vendedor:", error);
  }
}



    // 📌 Función para cerrar sesión
    async function logout() {
        try {
            await auth.signOut();
            console.log("✅ Usuario cerró sesión");
            hideProfileOnLogout(); // Ocultar perfil correctamente
            location.reload();
        } catch (error) {
            console.error("❌ Error al cerrar sesión:", error);
        }
    }

 
   
    // 📌 Cargar perfil desde Firestore y contar publicaciones/seguidores/seguidos
async function loadUserProfile(uid) {
    try {
        const userRef = doc(db, "usuarios", uid);
        const userSnap = await getDoc(userRef);

        let userData = {};
        if (userSnap.exists()) {
            userData = userSnap.data();
            console.log("📥 Datos del usuario recuperados de Firestore:", userData);

            // ✅ Actualizar campos de texto en el modal de perfil
            document.getElementById("modalProfileName").textContent = userData.name || auth.currentUser.displayName || "Usuario";
            document.getElementById("modalProfileUsername").textContent = userData.username ? "@" + userData.username : "";
            document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biografía";
        } else {
            console.warn("⚠️ No se encontró un documento en Firestore para el usuario:", uid);
        }

        // ✅ Imagen de perfil
        const user = auth.currentUser;
        let profilePhoto = userData.modalPhotoURL || userData.photoURL || (user ? user.photoURL : null);

        if (!profilePhoto) {
            console.warn("⚠️ No se encontró ninguna imagen en Firestore ni en Firebase Auth.");
            profilePhoto = "https://via.placeholder.com/80";
        }

        const profilePicModal = document.getElementById("profilePicModal");
        if (profilePicModal) {
            profilePicModal.src = profilePhoto;
            console.log("🖼️ Imagen cargada en el modal:", profilePhoto);
        }

        // ✅ CONTADORES 📊

        // 🔢 Contar publicaciones
        const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
        const postsSnap = await getDocs(postsQuery);
        const totalPosts = postsSnap.size;

        // 🔢 Contar seguidores
        const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
        const totalSeguidores = seguidoresSnap.size;

        // 🔢 Contar seguidos (a quién sigue este usuario)
        const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
        const totalSiguiendo = siguiendoSnap.size;

        // 🎯 Mostrar en HTML
        document.getElementById("profilePostCount").textContent = totalPosts;
        document.getElementById("profileFollowersCount").textContent = totalSeguidores;
        document.getElementById("profileFollowingCount").textContent = totalSiguiendo;

    } catch (error) {
        console.error("❌ Error al cargar perfil:", error);
    }
}




// 📌 Actualiza tu función updateUI así para evitar conflictos y pérdida de imagen:
function updateUI(user) {
    if (!user) return;                                                                                                                 
    console.log("📌 Tipo de cuenta detectado:", user.accountType);                                                                     
    const profilePic = document.getElementById("profilePic");
    const profilePicSidebar = document.getElementById("profilePicSidebar");
    // Usamos la foto original de Google para la interfaz principal
    const mainPhoto = user.photoURL || "https://via.placeholder.com/40";
    if (profilePic) profilePic.src = mainPhoto;
    if (profilePicSidebar) profilePicSidebar.src = mainPhoto;
    // Eliminamos la actualización del modal para no sobreescribir la imagen personalizada
    const profileName = document.getElementById("profileName");
    if (profileName) profileName.textContent = user.name || "Usuario";
    const profileContainer = document.getElementById("profileContainer");
    if (profileContainer) profileContainer.dataset.userType = user.accountType;
    if (user.accountType === "google") {
        document.getElementById("sellerProfileModal")?.classList.add("hidden");
        document.getElementById("googleProfileModal")?.classList.remove("hidden");
    } else if (user.accountType === "seller") {
        document.getElementById("googleProfileModal")?.classList.add("hidden");
        document.getElementById("sellerProfileModal")?.classList.remove("hidden");
    }
}


async function syncAccountTypeUI(user) {
    if (!user) return;

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const accountType = userData.accountType || "google";

    // Cambiar texto del botón
    const switchBtn = document.getElementById("switchToSellerBtn");
    if (switchBtn) {
        switchBtn.textContent =
            accountType === "seller"
                ? "Cambiar a cuenta de comprador"
                : "Cambiar a cuenta de vendedor";
    }

    // Mostrar el modal correcto si es necesario (por ejemplo, si ya estaba abierto)
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    if (profileContainerSidebar) {
        profileContainerSidebar.dataset.accountType = accountType;
    }

    // Actualizar foto y datos en el modal que esté visible
    if (accountType === "seller") {
    document.getElementById("sellerName").textContent = userData.name || "Vendedor";
    document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("sellerBio").textContent = userData.bio || "Sin biografía";
    const sellerPic = userData.modalPhotoURL || userData.photoURL || user.photoURL || "https://via.placeholder.com/100";
    document.getElementById("sellerProfilePic").src = sellerPic;

        // ✅ Contadores del vendedor
    await loadSellerProfile(user.uid);
  }
} // <-- CIERRA BIEN LA FUNCIÓN AQUÍ




async function loadSellerProfile(uid) {
  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      console.warn("⚠️ Vendedor no encontrado:", uid);
      return;
    }

    const userData = userSnap.data();

    // 👤 Datos del vendedor
    document.getElementById("sellerName").textContent = userData.name || "Vendedor";
    document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("sellerBio").textContent = userData.bio || "Sin biografía";
    document.getElementById("sellerProfilePic").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/100";

    // 📊 Publicaciones
    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    document.getElementById("sellerTweets").textContent = postsSnap.size;

    // 📊 Seguidores
    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    document.getElementById("sellerFollowers").textContent = seguidoresSnap.size;

    // 📊 Siguiendo
    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
    document.getElementById("sellerFollowing").textContent = siguiendoSnap.size;

  } catch (error) {
    console.error("❌ Error al cargar datos del perfil de vendedor:", error);
  }
}










let unsubscribePosts = null;
let userDataLoaded = false;
let currentAccountType = "usuario"; // declaración global

onAuthStateChanged(auth, async (user) => {
  console.log("🔄 Detectando cambios en la sesión...", user);

  const loginBtn = document.getElementById("loginBtn");
  const profileContainer = document.getElementById("profileContainer");
  const profilePic = document.getElementById("profilePic");
  const profileName = document.getElementById("profileName");
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  const profilePicSidebar = document.getElementById("profilePicSidebar");
  const usernameSidebar = document.getElementById("usernameSidebar");
  const profilePicModal = document.getElementById("profilePicModal");
  const publishBtn = document.getElementById("publishBtn");

  if (user) {

    console.log("✅ Sesión detectada: ", user.uid);

    let mainPhoto = user.photoURL || "https://via.placeholder.com/40";

    try {
      const userRef = doc(db, "usuarios", user.uid);
      const userSnap = await getDoc(userRef);
      let userData = userSnap.exists() ? userSnap.data() : null;

      currentAccountType = userData.accountType || "usuario"; // 👈 aquí mismo

      if (!userData) {
        console.log("🆕 Usuario no existía, creando perfil con UID...");

        userData = {
          uid: user.uid,
          username: user.displayName?.toLowerCase().replace(/\s+/g, "_") || "usuario_" + user.uid.slice(0, 4),
          name: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40",
          modalPhotoURL: user.photoURL || "https://via.placeholder.com/40",
          accountType: "usuario",
          createdAt: serverTimestamp()
        };

        await setDoc(userRef, userData);
        console.log("📝 Perfil creado correctamente en Firestore.");

        await new Promise(res => setTimeout(res, 300));
      }

      currentAccountType = userData.accountType || "usuario";

      
      mainPhoto = userData.modalPhotoURL || userData.photoURL || mainPhoto;

      if (profilePicModal) profilePicModal.src = mainPhoto;
      if (profileName) profileName.textContent = userData.name || "Usuario";
      if (profilePic) profilePic.src = mainPhoto;
      if (profilePicSidebar) profilePicSidebar.src = mainPhoto;
      if (usernameSidebar) usernameSidebar.textContent = userData.name || "Usuario";

      await syncAccountTypeUI(user);

      if (loginBtn) loginBtn.style.display = "none";
      if (profileContainer) profileContainer.style.display = "block";
      if (profileContainerSidebar) profileContainerSidebar.classList.remove("hidden");

      profileContainerSidebar.addEventListener("click", () => {
        const isSeller = userData.accountType === "vendedor";

        document.getElementById("profileModal").classList.add("hidden");
        document.getElementById("sellerProfileModal").classList.add("hidden");

        if (isSeller) {
          document.getElementById("sellerProfilePic").src = "https://via.placeholder.com/100";
          document.getElementById("sellerName").textContent = "";
          document.getElementById("sellerUsername").textContent = "";
          document.getElementById("sellerBio").textContent = "";

          document.getElementById("sellerProfilePic").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/100";
          document.getElementById("sellerName").textContent = userData.name || "Vendedor";
          document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
          document.getElementById("sellerBio").textContent = userData.bio || "";

          document.getElementById("sellerProfileModal").classList.remove("hidden");
        } else {
          document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
          document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
          document.getElementById("modalProfileBio").textContent = userData.bio || "";
          document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";

          document.getElementById("profileModal").classList.remove("hidden");
          document.getElementById("modalContent").classList.remove("scale-95", "opacity-0");
        }
      });

      if (unsubscribePosts) unsubscribePosts();

      console.log("🟢 Esperando para cargar publicaciones...");
      setTimeout(() => {
        console.log("📡 Iniciando listenForPosts()");
        listenForPosts();
      }, 400);

      userDataLoaded = true;
      if (publishBtn) publishBtn.disabled = false;

    } catch (error) {
      console.error("❌ Error al recuperar/crear datos del usuario:", error);
      if (publishBtn) publishBtn.disabled = true;
      userDataLoaded = false;
    }

  } else {
    console.log("🚪 No hay usuario, cerrando sesión visual...");

    if (loginBtn) loginBtn.style.display = "block";
    if (profileContainer) profileContainer.style.display = "none";
    if (profileContainerSidebar) profileContainerSidebar.classList.add("hidden");
    hideProfileOnLogout();

    if (unsubscribePosts) unsubscribePosts();

    if (publishBtn) publishBtn.disabled = true;
    userDataLoaded = false;
  }
});













// 📌 Función para ocultar el perfil al cerrar sesión
function hideProfileOnLogout() {
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    profileContainerSidebar.classList.add("hidden");

    const profilePic = document.getElementById("profilePic");
    const profileName = document.getElementById("profileName");
    const loginBtn = document.getElementById("loginBtn");

    if (profilePic) profilePic.src = "";
    if (profileName) profileName.textContent = "";
    if (loginBtn) loginBtn.style.display = "block";

// Sistema de notificaciones mejorado
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type} fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg transition`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Limpieza al salir de la página
window.addEventListener('beforeunload', () => {
    if (unsubscribePosts) {
        unsubscribePosts();
    }
});

// Inicialización de la persistencia de Firestore
async function enablePersistence() {
    try {
        await enableIndexedDbPersistence(db);
        console.log("Persistencia de Firestore habilitada");
    } catch (err) {
        if (err.code == 'failed-precondition') {
            console.warn("Persistencia falló: Múltiples pestañas abiertas");
        } else if (err.code == 'unimplemented') {
            console.warn("Persistencia no soportada en este navegador");
        }
    }
}

enablePersistence();    const profilePicSidebar = document.getElementById("profilePicSidebar");
    if (profilePicSidebar) profilePicSidebar.src = "";
}


// 📌 Eventos de UI
document.getElementById("loginBtn")?.addEventListener("click", () => {
    document.getElementById("loginModal")?.classList.remove("hidden");
});

document.getElementById("closeModal")?.addEventListener("click", () => {
    document.getElementById("loginModal")?.classList.add("hidden");
});

document.getElementById("googleLoginBtn")?.addEventListener("click", login);
document.getElementById("sellerLoginBtn")?.addEventListener("click", loginAsSeller);
document.getElementById("logoutBtn")?.addEventListener("click", logout);

document.getElementById("editProfileBtn")?.addEventListener("click", async () => {
    document.getElementById("editProfileModal")?.classList.remove("hidden");

    const user = auth.currentUser;
    if (user) {
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();

            // 🔄 Imagen de perfil personalizada o fallback
            const photoURL = userData.modalPhotoURL || userData.photoURL || user.photoURL || "https://via.placeholder.com/80";
            document.getElementById("editProfilePic").src = photoURL;

            // Datos de perfil
            document.getElementById("editProfileName").value = userData.name || user.displayName || "";
            document.getElementById("editProfileUsername").value = (userData.username || "").replace(/^@/, "");
            document.getElementById("editProfileBio").value = userData.bio || "";
        }
    }
});

document.getElementById("closeEditProfileModal")?.addEventListener("click", () => {
    document.getElementById("editProfileModal")?.classList.add("hidden");
});

document.getElementById("saveProfileBtn")?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("❌ No hay usuario autenticado.");
        return;
    }

    const newName = document.getElementById("editProfileName").value.trim();
    const rawUsername = document.getElementById("editProfileUsername").value.trim();
    const newUsername = rawUsername.replace(/^@/, "").trim(); // sin @
    const newBio = document.getElementById("editProfileBio").value.trim();

    try {
        // Actualizar displayName en Auth
        await user.updateProfile({ displayName: newName });

        // Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, {
            name: newName,
            username: newUsername,
            bio: newBio
        }, { merge: true });

        console.log("✅ Perfil actualizado correctamente.");
        alert("✅ Perfil actualizado con éxito.");

        // Refrescar datos en el modal principal
        await loadUserProfile(user.uid);

        // Cerrar el modal de edición
        document.getElementById("editProfileModal").classList.add("hidden");
    } catch (error) {
        console.error("❌ Error al actualizar el perfil:", error);
    }
});

























async function loadFollowingInMessages() {
  const currentUser = auth.currentUser;
  const followingListContainer = document.getElementById("followingList");

  if (!currentUser || !followingListContainer) return;

  try {
    const seguidosRef = collection(db, "usuarios", currentUser.uid, "seguidos");
    const snapshot = await getDocs(seguidosRef);

    followingListContainer.innerHTML = "";

    if (snapshot.empty) {
      followingListContainer.innerHTML = `<p class="text-sm text-gray-500">No sigues a nadie aún.</p>`;
      return;
    }

    for (const docSnap of snapshot.docs) {
      const seguidoUID = docSnap.id;
      const seguidoRef = doc(db, "usuarios", seguidoUID);
      const seguidoSnap = await getDoc(seguidoRef);

      if (seguidoSnap.exists()) {
        const data = seguidoSnap.data();
        const name = data.name || "Sin nombre";
        const photo = data.modalPhotoURL || data.photoURL || "https://via.placeholder.com/80";

        const userDiv = document.createElement("div");
        userDiv.className = "flex flex-col items-center cursor-pointer";
        userDiv.innerHTML = `
          <img src="${photo}" class="w-12 h-12 rounded-full border-2 border-green-400" alt="${name}">
          <span class="text-xs font-medium mt-1">${name}</span>
        `;

        // ✅ Reemplazamos el console.log por apertura de chat
        userDiv.addEventListener("click", () => {
          openChatWithUser(seguidoUID);
        });

        followingListContainer.appendChild(userDiv);
      }
    }
  } catch (error) {
    console.error("❌ Error al cargar usuarios seguidos:", error);
    followingListContainer.innerHTML = `<p class="text-sm text-red-500">Error al cargar usuarios.</p>`;
  }
}















// ✅ FUNCIÓN PARA CARGAR CONTADORES EN MODAL DE VENDEDOR
async function loadSellerCounts(uid) {
  try {
    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    document.getElementById("sellerTweets").textContent = postsSnap.size;

    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    document.getElementById("sellerFollowers").textContent = seguidoresSnap.size;

    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
    document.getElementById("sellerFollowing").textContent = siguiendoSnap.size;

    console.log("📊 Contadores de vendedor cargados:", uid);
  } catch (error) {
    console.error("❌ Error al cargar contadores de vendedor:", error);
  }
}







// ✅ Función global para contar publicaciones, seguidores y seguidos
async function loadProfileCounts(uid) {
  try {
    // 📊 Contar publicaciones
    const postsQuery = query(collection(db, "posts"), where("uid", "==", uid));
    const postsSnap = await getDocs(postsQuery);
    document.getElementById("profilePostCount").textContent = postsSnap.size;

    // 📊 Contar seguidores
    const seguidoresSnap = await getDocs(collection(db, "usuarios", uid, "seguidores"));
    document.getElementById("profileFollowersCount").textContent = seguidoresSnap.size;

    // 📊 Contar seguidos
    const siguiendoSnap = await getDocs(collection(db, "usuarios", uid, "seguidos"));
    document.getElementById("profileFollowingCount").textContent = siguiendoSnap.size;

    console.log("📊 Contadores cargados correctamente para:", uid);
  } catch (error) {
    console.error("❌ Error al contar publicaciones o seguidores:", error);
  }
}



// ✅ Funciones globales

function openModal() {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "usuarios", user.uid);
    getDoc(userRef).then(async (userSnap) => {
        if (userSnap.exists()) {
            const userData = userSnap.data();
            const accountType = userData.accountType || "google";

            if (accountType === "seller") {
                const sellerModal = document.getElementById("sellerProfileModal");
                if (sellerModal) {
                    sellerModal.classList.remove("hidden");
                    sellerModal.style.display = "flex";
                }
            } else {
                const profileModal = document.getElementById("profileModal");
                const modalOverlay = document.getElementById("modalOverlay");
                const modalContent = document.getElementById("modalContent");

                if (!profileModal || !modalOverlay || !modalContent) {
                    console.error("❌ No se encontraron elementos del modal.");
                    return;
                }

                profileModal.classList.remove("hidden");
                profileModal.style.display = "flex";
                modalOverlay.classList.remove("hidden");

                setTimeout(() => {
                    modalContent.classList.remove("scale-95", "opacity-0");
                    modalContent.classList.add("scale-100", "opacity-100");
                }, 10);

                document.body.style.overflow = "hidden";

                const profilePicModal = document.getElementById("profilePicModal");
                if (profilePicModal) {
                    profilePicModal.src = user.photoURL || "https://via.placeholder.com/80";
                }

                const editBtn = document.getElementById("openEditProfileFromModal");
                const followBtn = document.getElementById("followBtn");
                if (editBtn) editBtn.classList.remove("hidden");
                if (followBtn) followBtn.classList.add("hidden");

               // ✅ Cargar datos del perfil
               await loadUserProfile(user.uid);

               // ✅ Cargar contadores: publicaciones, seguidores, seguidos
                await loadProfileCounts(user.uid);


               // ✅ Mostrar solo tus publicaciones dentro del modal
               loadUserPosts(user.uid);



             }

        }
    }).catch((error) => {
        console.error("❌ Error al verificar tipo de cuenta:", error);
    });
}

function closeModal() {
    const profileModal = document.getElementById("profileModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalContent = document.getElementById("modalContent");

    if (!profileModal || !modalOverlay || !modalContent) {
        console.error("❌ No se encontraron elementos del modal.");
        return;
    }

    modalContent.classList.add("scale-95", "opacity-0");
    modalContent.classList.remove("scale-100", "opacity-100");

    setTimeout(() => {
        profileModal.classList.add("hidden");
        profileModal.style.display = "none";
        modalOverlay.classList.add("hidden");
        document.body.style.overflow = "auto";
    }, 300);
}



document.addEventListener("DOMContentLoaded", function () {
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    const closeProfileModal = document.getElementById("closeProfileModal");
    const modalOverlay = document.getElementById("modalOverlay");

    if (!profileContainerSidebar || !closeProfileModal || !modalOverlay) {
        console.error("❌ Error: No se encontraron algunos elementos del modal.");
        return;
    }

    profileContainerSidebar.addEventListener("click", openModal);
    closeProfileModal.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", closeModal);

    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });
});











document.getElementById("openEditProfileFromModal").addEventListener("click", function () {
    // Cerrar el modal del perfil
    closeModal();

    // Abrir el modal de edición de perfil
    openEditProfileModal();
});


function openEditProfileModal() {
    const editProfileModal = document.getElementById("editProfileModal");
    if (!editProfileModal) {
        console.error("❌ No se encontró el modal de edición de perfil.");
        return;
    }

    editProfileModal.classList.remove("hidden");
    editProfileModal.style.display = "flex";

    setTimeout(() => {
        editProfileModal.classList.remove("scale-95", "opacity-0");
        editProfileModal.classList.add("scale-100", "opacity-100");
    }, 10);

    const user = auth.currentUser;
    if (user) {
        const userRef = doc(db, "usuarios", user.uid);
        getDoc(userRef).then((userSnap) => {
            if (userSnap.exists()) {
                const userData = userSnap.data();

                // ✅ Imagen de perfil personalizada
                const profilePicUrl = userData.modalPhotoURL || user.photoURL || "https://via.placeholder.com/80";
                document.getElementById("editProfilePic").src = profilePicUrl;

                // ✅ Datos del usuario
                document.getElementById("editProfileName").value = userData.name || user.displayName || "";
                document.getElementById("editProfileUsername").value = (userData.username || "").replace(/^@/, "");
                document.getElementById("editProfileBio").value = userData.bio || "";

                // ✅ Cambiar texto del botón según el tipo de cuenta
                const switchBtn = document.getElementById("switchToSellerBtn");
                if (switchBtn) {
                    if (userData.accountType === "seller") {
                        switchBtn.textContent = "Cambiar a cuenta de comprador";
                    } else {
                        switchBtn.textContent = "Cambiar a cuenta de vendedor";
                    }
                }
            }
        }).catch((error) => {
            console.error("❌ Error al recuperar datos del usuario:", error);
        });
    }
}


// Abrir modal de edición desde el perfil de vendedor
document.getElementById("editSellerProfileBtn")?.addEventListener("click", () => {
    // Ocultar el modal de perfil de vendedor
    document.getElementById("sellerProfileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal").style.display = "none";

    // Abrir el modal de edición de perfil
    openEditProfileModal();
});



document.getElementById("saveProfileBtn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("❌ No hay usuario autenticado.");
        return;
    }

    const newName = document.getElementById("editProfileName").value.trim();
    const rawUsername = document.getElementById("editProfileUsername").value.trim();
    const newUsername = rawUsername.replace(/^@/, "").trim();
    const newBio = document.getElementById("editProfileBio").value.trim();

    try {
        // ✅ Actualizar nombre en Firebase Auth correctamente
        await updateProfile(user, { displayName: newName });

        // ✅ Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, {
            name: newName,
            username: newUsername,
            bio: newBio
        }, { merge: true });

        alert("✅ Perfil actualizado con éxito.");
        await loadUserProfile(user.uid);

        // Actualizar los elementos del modal directamente
        const updatedSnap = await getDoc(userRef);
        if (updatedSnap.exists()) {
            const updatedData = updatedSnap.data();
            document.getElementById("modalProfileName").textContent = updatedData.name;
            document.getElementById("modalProfileUsername").textContent = "@" + updatedData.username;
            document.getElementById("modalProfileBio").textContent = updatedData.bio || "Sin biografía";
        }

        document.getElementById("editProfileModal").classList.add("hidden");

    } catch (error) {
        console.error("❌ Error al actualizar el perfil:", error);
        alert("❌ Ocurrió un error al actualizar el perfil.\n" + error.message);
    }
});







document.getElementById("switchToSellerBtn")?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("❌ No hay usuario autenticado.");
        return;
    }

    try {
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            alert("⚠️ No se encontraron datos del usuario.");
            return;
        }

        const userData = userSnap.data();
        const currentType = userData.accountType || "google";

        // 🔁 Cambiar el tipo de cuenta dinámicamente
        const newType = currentType === "seller" ? "google" : "seller";
        const newLabel = newType === "seller" ? "Cambiar a cuenta de comprador" : "Cambiar a cuenta de vendedor";

        await setDoc(userRef, { accountType: newType }, { merge: true });
        alert(`✅ Tu cuenta ahora es tipo: ${newType}`);

        // 🔄 Actualizar texto del botón
        const switchBtn = document.getElementById("switchToSellerBtn");
        if (switchBtn) switchBtn.textContent = newLabel;

        // 🔒 Cerrar modales previos
        document.getElementById("editProfileModal")?.classList.add("hidden");
        document.getElementById("profileModal")?.classList.add("hidden");
        document.getElementById("profileModal").style.display = "none";
        document.getElementById("sellerProfileModal")?.classList.add("hidden");
        document.getElementById("sellerProfileModal").style.display = "none";

        // 🔄 Actualizar UI
        const updatedSnap = await getDoc(userRef);
        if (updatedSnap.exists()) {
            const data = updatedSnap.data();

            if (newType === "seller") {
                document.getElementById("sellerName").textContent = data.name || "Vendedor";
                document.getElementById("sellerUsername").textContent = "@" + (data.username || "usuario");
                document.getElementById("sellerBio").textContent = data.bio || "Sin biografía";

                const sellerPic = data.modalPhotoURL || data.photoURL || user.photoURL || "https://via.placeholder.com/100";
                document.getElementById("sellerProfilePic").src = sellerPic;

                const sellerModal = document.getElementById("sellerProfileModal");
                if (sellerModal) {
                    sellerModal.classList.remove("hidden");
                    sellerModal.style.display = "flex";


                    // ✅ Cargar contadores para el modal de vendedor
                    await loadSellerCounts(user.uid);

                }
            }
        }

    } catch (error) {
        console.error("❌ Error al cambiar tipo de cuenta:", error);
        alert("❌ Hubo un error al cambiar el tipo de cuenta.");
    }
});

if (!window.__MODAL_PERFIL_VENDEDOR_ACTIVO) {
  window.__MODAL_PERFIL_VENDEDOR_ACTIVO = true;

  document.addEventListener("DOMContentLoaded", () => {
    // 👉 Abrir modal de PEDIDOS
    const openOrdersBtn  = document.getElementById("openOrdersModal");
    const ordersModal    = document.getElementById("ordersModal");
    const closeOrdersBtn = document.getElementById("closeOrdersModal");

    openOrdersBtn?.addEventListener("click", () => {
      ordersModal?.classList.remove("hidden");
      ordersModal.style.display = "flex";
    });

    closeOrdersBtn?.addEventListener("click", () => {
      ordersModal?.classList.add("hidden");
      ordersModal.style.display = "none";
    });

    ordersModal?.addEventListener("click", (e) => {
      if (e.target.id === "ordersModal") {
        ordersModal.classList.add("hidden");
        ordersModal.style.display = "none";
      }
    });

    // 👉 Abrir modal de INGRESOS
    const openEarningsBtn  = document.getElementById("openEarningsModal");
    const earningsModal    = document.getElementById("earningsModal");
    const closeEarningsBtn = document.getElementById("closeEarningsModal");

    openEarningsBtn?.addEventListener("click", () => {
      earningsModal?.classList.remove("hidden");
      earningsModal.style.display = "flex";
    });

    closeEarningsBtn?.addEventListener("click", () => {
      earningsModal?.classList.add("hidden");
      earningsModal.style.display = "none";
    });

    earningsModal?.addEventListener("click", (e) => {
      if (e.target.id === "earningsModal") {
        earningsModal.classList.add("hidden");
        earningsModal.style.display = "none";
      }
    });

    // 👉 Cerrar modal de vendedor
    const closeSellerBtn = document.getElementById("closeSellerModal");
    const sellerModal    = document.getElementById("sellerProfileModal");

    closeSellerBtn?.addEventListener("click", () => {
      sellerModal?.classList.add("hidden");
      sellerModal.style.display = "none";
    });

    sellerModal?.addEventListener("click", (e) => {
      if (e.target.id === "sellerProfileModal") {
        sellerModal.classList.add("hidden");
        sellerModal.style.display = "none";
      }
    });
  });
}







window.openModalFromPost = function(uid) {
  getDoc(doc(db, "usuarios", uid)).then(userSnap => {
    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const currentUser = auth.currentUser;

    // 🔒 Cerrar modales por si acaso
    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    // ✅ FORZAR siempre el modal normal, aunque sea vendedor
    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biografía";
    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";

    // ✅ Mostrar el botón correcto según si es el perfil actual o no
    const editBtn = document.getElementById("openEditProfileFromModal");
    const followBtn = document.getElementById("followBtn");

    if (currentUser && currentUser.uid === uid) {
      editBtn.classList.remove("hidden");
      followBtn.classList.add("hidden");
    } else {
      editBtn.classList.add("hidden");
      followBtn.classList.remove("hidden");
      followBtn.textContent = "Seguir";
    }

    const modal = document.getElementById("profileModal");
    const modalContent = document.getElementById("modalContent");
    const modalOverlay = document.getElementById("modalOverlay");

    modal.classList.remove("hidden");
    modal.style.display = "flex";

    if (modalOverlay) {
      modalOverlay.classList.remove("hidden");
      modalOverlay.style.display = "block";
    }

    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);

    // ✅ Cargar contadores
    loadUserProfile(uid);

  }).catch(error => {
    console.error("❌ Error al abrir modal desde publicación:", error);
    alert("❌ No se pudo abrir el perfil.");
  });
};




// Al hacer clic en el nombre del usuario
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("username-link")) {
        const uid = e.target.dataset.uid;
        if (uid) openModalFromPost(uid);
    }
});

// Al hacer clic en la imagen del perfil → vista previa grande
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("profile-pic-clickable")) {
        const modal = document.getElementById("profilePicPreviewModal");
        const img = document.getElementById("previewProfilePic");
        img.src = e.target.dataset.img;
        modal.classList.remove("hidden");
    }
});

// Cerrar modal de imagen al hacer clic fuera del círculo
document.getElementById("profilePicPreviewModal")?.addEventListener("click", (e) => {
    if (e.target.id === "profilePicPreviewModal") {
        e.currentTarget.classList.add("hidden");
    }
});










// 🟢 PUBLICAR POST (guarda perfil en el post)
document.getElementById("publishBtn")?.addEventListener("click", async (e) => {
  const btn = e.currentTarget;
  btn.disabled = true;
  btn.textContent = "Publicando...";

  const text = document.getElementById("postInput").value.trim();
  const imageInput = document.getElementById("postImageInput");
  const file = imageInput.files[0];

  if (!text && !file) {
    alert("⚠️ Escribe algo o sube una imagen o video.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("⚠️ Debes estar logueado.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  if (!userDataLoaded) {
    alert("⚠️ Espera a que se cargue tu perfil correctamente antes de publicar.");
    btn.disabled = false;
    btn.textContent = "Publicar";
    return;
  }

  let mediaURL = "";
  let isVideo = false;

  if (file) {
    try {
      const fileType = file.type;
      isVideo = fileType.startsWith("video/");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "Tweetsocial");

      const uploadURL = isVideo
        ? "https://api.cloudinary.com/v1_1/dz70korgo/video/upload"
        : "https://api.cloudinary.com/v1_1/dz70korgo/image/upload";

      const response = await fetch(uploadURL, {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      if (!data.secure_url) {
        alert("❌ Error al subir el archivo a Cloudinary.");
        btn.disabled = false;
        btn.textContent = "Publicar";
        return;
      }

      mediaURL = data.secure_url;
    } catch (error) {
      console.error("❌ Error al subir archivo:", error);
      alert("❌ Ocurrió un error al subir el archivo.");
      btn.disabled = false;
      btn.textContent = "Publicar";
      return;
    }
  }

  // 🔥 Leer perfil desde Firestore
  let profileData = {};
  try {
    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const data = userSnap.data();
      profileData = {
        accountType: data.accountType || "",
        bio: data.bio || "",
        modalPhotoURL: data.modalPhotoURL || "",
        name: data.name || "",
        username: data.username || "",
        photoURL: data.photoURL || "" // Asegura que se incluya la imagen de Google si no hay modalPhotoURL
      };
    }
  } catch (e) {
    console.warn("⚠️ No se pudo obtener perfil del usuario:", e);
  }

  // 🔥 Publicar en Firestore con perfil incluido
  try {
    await addDoc(collection(db, "posts"), {
      uid: user.uid,
      text: text,
      mediaURL: mediaURL,
      isVideo: isVideo,
      timestamp: serverTimestamp(),
      ...profileData // 👈 Aquí se agrega el perfil al post
    });

    document.getElementById("postInput").value = "";
    imageInput.value = "";

    alert("✅ Publicación realizada con éxito.");
  } catch (err) {
    console.error("❌ Error al guardar la publicación:", err);
    alert("❌ Error al guardar la publicación en Firestore.");
  } finally {
    btn.disabled = false;
    btn.textContent = "Publicar";
  }
});




// 👁️ ESCUCHAR PUBLICACIONES EN TIEMPO REAL (Versión final y sincronizada)
function listenForPosts() {
  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

  unsubscribePosts = onSnapshot(q, (snapshot) => {
    const postsContainer = document.getElementById("postsContainer");
    if (!postsContainer) return console.error("❌ No se encontró #postsContainer.");

    const postHTMLArray = [];

    snapshot.forEach((docSnap) => {
      const postData = docSnap.data();
      if (!postData?.uid) return;

      // ✅ Ya viene todo desde el post (name, username, photoURL, etc.)
      postHTMLArray.push(renderPostHTML(postData));
    });

    postsContainer.innerHTML = postHTMLArray.join("");
  }, (error) => {
    console.error("🔥 Error en snapshot de posts:", error);
    const postsContainer = document.getElementById("postsContainer");
    if (postsContainer) {
      postsContainer.innerHTML = `<div class="text-center py-4 text-red-500">Error al cargar publicaciones.</div>`;
    }
  });
}
















function renderPostHTML(docData, userData = {}, postId = "") {
  const safeUser = {
    username: docData.username || userData.username || "usuario",
    name: docData.name || userData.name || "Usuario",
    photoURL: docData.modalPhotoURL || docData.photoURL || userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/40",
    accountType: docData.accountType || userData.accountType || "usuario"
  };

  const uid = docData?.uid || userData?.uid || "";

  // 📦 Post tipo "venta"
  if (docData.tipo === "venta") {
    return `
      <div class="bg-yellow-100 p-5 rounded shadow-md mt-4 border border-yellow-300">
        <div class="flex items-center mb-2">
          <img src="${safeUser.photoURL}"
               class="w-10 h-10 rounded-full cursor-pointer profile-pic-clickable"
               data-uid="${uid}"
               data-account-type="${safeUser.accountType}"
               alt="Foto de ${safeUser.name}"
               onerror="this.src='https://via.placeholder.com/40'" />
          <span class="ml-2 text-blue-600 cursor-pointer username-link"
                data-uid="${uid}"
                data-account-type="${safeUser.accountType}">
            @${safeUser.username}
          </span>
        </div>
        <h3 class="text-lg font-semibold text-gray-800 mb-1">${docData.titulo || "Producto sin título"}</h3>
        <p class="text-gray-700 mb-1">${docData.descripcion || ""}</p>
        <p class="text-green-700 font-bold mb-2">💲${docData.precio || 0}</p>
        ${
          docData.imagen
            ? docData.isVideo
              ? `<video class="media-clickable w-full max-h-60 object-cover rounded cursor-pointer mb-3" src="${docData.imagen}"></video>`
              : `<img src="${docData.imagen}" class="media-clickable w-full max-h-60 object-cover rounded cursor-pointer mb-3" alt="Producto">`
            : ""
        }
        <div class="flex mt-2 space-x-4 text-sm text-gray-600">
          <button class="show-comments-btn bg-gray-200 px-3 py-1 rounded cursor-pointer" data-post-id="${postId}">💬 Comentarios</button>
          <button class="hover:text-red-500">❤️</button>
        </div>
      </div>
    `;
  }

  // ✍️ Post normal
  return `
    <div class="bg-white p-5 rounded shadow-md mt-4">
      <div class="flex items-center mb-2">
        <img src="${safeUser.photoURL}"
             class="w-10 h-10 rounded-full cursor-pointer profile-pic-clickable"
             data-uid="${uid}"
             data-account-type="${safeUser.accountType}"
             alt="Foto de ${safeUser.name}"
             onerror="this.src='https://via.placeholder.com/40'" />
        <span class="ml-2 text-blue-600 cursor-pointer username-link"
              data-uid="${uid}"
              data-account-type="${safeUser.accountType}">
          @${safeUser.username}
        </span>
      </div>
      <p class="text-gray-700">${docData.text || ""}</p>
      ${
        docData.mediaURL
          ? docData.isVideo
            ? `<video class="media-clickable mt-2 max-h-60 mx-auto rounded cursor-pointer" src="${docData.mediaURL}"></video>`
            : `<div class="mt-2">
                 <img src="${docData.mediaURL}"
                      class="media-clickable max-h-40 object-cover mx-auto rounded cursor-pointer"
                      alt="Contenido multimedia"
                      onerror="this.style.display='none'" />
               </div>`
          : ""
      }
      <div class="flex mt-3 space-x-4">
        <button class="show-comments-btn bg-gray-200 px-3 py-1 rounded cursor-pointer" data-post-id="${postId}">💬 Comentarios</button>
        <button class="text-red-500">❤️</button>
        <button class="text-gray-600">🔗</button>
      </div>
    </div>
  `;
}














document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("username-link")) return;

  const uid = e.target.dataset.uid;
  if (!uid) {
    alert("❌ No se pudo identificar el UID del usuario.");
    return;
  }

  console.log("🔍 Clic en username, buscando datos para UID:", uid);

  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      alert("❌ Usuario no encontrado en Firestore.");
      return;
    }

    const userData = userSnap.data();
    console.log("✅ Datos del usuario:", userData);

    // 🔒 Cerrar modales por si acaso
    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    // 🔄 Mostrar SIEMPRE modal normal
    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";
    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "";

    const editBtn = document.getElementById("openEditProfileFromModal");
    const followBtn = document.getElementById("followBtn");

    const currentUser = auth.currentUser;
    const isOwnProfile = currentUser && currentUser.uid === uid;

    if (isOwnProfile) {
      editBtn?.classList.remove("hidden");
      followBtn?.classList.add("hidden");
    } else {
      editBtn?.classList.add("hidden");
      followBtn?.classList.remove("hidden");

      followBtn.dataset.uid = uid; // Guardamos el UID en el botón

      // 🔍 Verificar si YA lo sigue
      const followRef = doc(db, "usuarios", uid, "seguidores", currentUser.uid);
      const followSnap = await getDoc(followRef);

      if (followSnap.exists()) {
        followBtn.textContent = "Siguiendo";
        followBtn.classList.remove("bg-blue-500");
        followBtn.classList.add("bg-green-500");
      } else {
        followBtn.textContent = "Seguir";
        followBtn.classList.remove("bg-green-500");
        followBtn.classList.add("bg-blue-500");
      }
    }

    // 🔥 Mostrar modal
    const modal = document.getElementById("profileModal");
    const content = document.getElementById("modalContent");

    modal.classList.remove("hidden");
    modal.style.display = "flex";

    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

  } catch (err) {
    console.error("❌ Error al obtener perfil:", err);
    alert("❌ No se pudo abrir el perfil.\n\n" + err.message);
  }
});




// ✅ Botón seguir real que guarda en Firestore y actualiza contadores
document.getElementById("followBtn")?.addEventListener("click", async function () {
  const followBtn = this;
  const viewedUID = followBtn.dataset.uid;
  const currentUser = auth.currentUser;

  if (!viewedUID || !currentUser) {
    alert("❌ No se pudo procesar el seguimiento.");
    return;
  }

  const followerRef = doc(db, "usuarios", viewedUID, "seguidores", currentUser.uid);
  const followingRef = doc(db, "usuarios", currentUser.uid, "seguidos", viewedUID);

  try {
    const docSnap = await getDoc(followerRef);

    if (docSnap.exists()) {
      // 👉 Ya lo sigue → dejar de seguir
      await deleteDoc(followerRef);
      await deleteDoc(followingRef);

      followBtn.textContent = "Seguir";
      followBtn.classList.remove("bg-green-500");
      followBtn.classList.add("bg-blue-500");
    } else {
      // 👉 No lo sigue → empezar a seguir
      await setDoc(followerRef, {
        seguidorUID: currentUser.uid,
        followedAt: Date.now()
      });
      await setDoc(followingRef, {
        seguidoUID: viewedUID,
        followedAt: Date.now()
      });

      followBtn.textContent = "Siguiendo";
      followBtn.classList.remove("bg-blue-500");
      followBtn.classList.add("bg-green-500");
    }

    // ✅ Actualizar contadores en tiempo real
    await loadProfileCounts(viewedUID);

  } catch (error) {
    console.error("❌ Error al seguir/dejar de seguir:", error);
    alert("❌ Hubo un error al actualizar el seguimiento.\n\n" + error.message);
  }
});





// 👇 Evento para abrir/cerrar el modal de la imagen de perfil
document.addEventListener("DOMContentLoaded", () => {
  const profileModal = document.getElementById("profilePicPreviewModal");
  const profileImgPreview = document.getElementById("previewProfilePic");

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("profile-pic-clickable")) {
      const src = e.target.getAttribute("src");
      profileImgPreview.src = src;
      profileModal.classList.remove("hidden");
    }
  });

  profileModal.addEventListener("click", (e) => {
    if (e.target === profileModal) {
      profileModal.classList.add("hidden");
      profileImgPreview.src = "";
    }
  });
});







let activeSimpleChatUid = null;
let activeReceiverUid = null;
let unsubscribeSimpleChat = null; // 🧠 Muy importante

window.openSimpleMessagesModal = function () {
  const modal = document.getElementById("simpleMessagesModal");
  modal.classList.remove("hidden");
  modal.style.display = "flex";

  document.getElementById("simpleChatBox").classList.add("hidden");
  document.getElementById("simpleChatMessages").innerHTML = "";
  document.getElementById("simpleMessageInput").value = "";

  document.body.classList.add("overflow-hidden");

  loadSimpleFollowingList();
};

window.closeSimpleMessagesModal = function () {
  const modal = document.getElementById("simpleMessagesModal");
  modal.classList.add("hidden");
  modal.style.display = "none";

  document.getElementById("simpleChatBox").classList.add("hidden");
  document.getElementById("simpleChatMessages").innerHTML = "";
  document.getElementById("simpleMessageInput").value = "";

  if (typeof unsubscribeSimpleChat === "function") {
    unsubscribeSimpleChat();
    unsubscribeSimpleChat = null;
  }

  activeSimpleChatUid = null;
  activeReceiverUid = null;

  document.body.classList.remove("overflow-hidden");
};

async function loadSimpleFollowingList() {
  const user = auth.currentUser;
  const container = document.getElementById("simpleFollowingList");
  container.innerHTML = "";

  const seguidosSnap = await getDocs(collection(db, "usuarios", user.uid, "seguidos"));
  for (const docSnap of seguidosSnap.docs) {
    const followedUid = docSnap.id;
    const userSnap = await getDoc(doc(db, "usuarios", followedUid));
    if (!userSnap.exists()) continue;

    const userData = userSnap.data();

    const item = document.createElement("div");
    item.className = "flex items-center gap-3 cursor-pointer hover:bg-gray-100 p-2 rounded";
    item.innerHTML = `
      <img src="${userData.modalPhotoURL || userData.photoURL || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border" />
      <div>
        <div class="font-medium text-sm">${userData.name || "Usuario"}</div>
        <div class="text-xs text-gray-500">@${userData.username || "usuario"}</div>
      </div>
    `;
    item.onclick = () => openSimpleChatWithUser(followedUid, userData.name);
    container.appendChild(item);
  }
}

function openSimpleChatWithUser(otherUid, otherName) {
  const currentUid = auth.currentUser.uid;
  activeReceiverUid = otherUid;
  activeSimpleChatUid = [currentUid, otherUid].sort().join("_");

  document.getElementById("simpleChatBox").classList.remove("hidden");
  document.getElementById("chatWithName").textContent = "Hablando con: " + otherName;

  const messagesRef = collection(db, "chats", activeSimpleChatUid, "messages");
  const q = query(messagesRef, orderBy("timestamp"));
  const container = document.getElementById("simpleChatMessages");
  container.innerHTML = "";

  if (typeof unsubscribeSimpleChat === "function") {
    unsubscribeSimpleChat();
  }

  unsubscribeSimpleChat = onSnapshot(q, (snapshot) => {
    container.innerHTML = "";

    snapshot.forEach((doc) => {
      const msg = doc.data();
      const isMine = msg.senderId === currentUid;

      const messageWrapper = document.createElement("div");
      messageWrapper.className = `flex mb-2 items-end ${isMine ? "justify-end" : "justify-start"}`;

      const bubbleWrapper = document.createElement("div");
      bubbleWrapper.className = "flex flex-col max-w-[70%]";

      const bubble = document.createElement("div");
      bubble.className = `px-4 py-2 rounded-xl text-sm shadow relative ${
        isMine
          ? "bg-blue-500 text-white rounded-br-none self-end"
          : "bg-gray-100 text-gray-900 rounded-bl-none self-start"
      }`;
      bubble.textContent = msg.text;

      // 🔒 Prevenir selección de texto y menú del sistema
      bubble.setAttribute("unselectable", "on");
      bubble.style.userSelect = "none";
      bubble.style.webkitUserSelect = "none";
      bubble.style.msUserSelect = "none";

      // ⏰ Hora del mensaje
      const time = document.createElement("div");
      const date = msg.timestamp?.toDate();
      time.textContent = date
        ? date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
        : "";
      time.className = `text-xs mt-1 ${
        isMine ? "text-right text-white/70" : "text-left text-gray-500"
      }`;

      // 💬 Contenedor para reacciones
      const reactionBar = document.createElement("div");
      if (msg.reactions && Object.keys(msg.reactions).length > 0) {
        const uniqueEmojis = [...new Set(Object.values(msg.reactions))];
        reactionBar.textContent = uniqueEmojis.join(" ");
        reactionBar.className = `text-sm mt-1 ${
          isMine ? "text-right text-white/80" : "text-left text-gray-600"
        }`;
      } else {
        reactionBar.textContent = "";
        reactionBar.className = "min-h-[1.5em]"; // mantener espacio aunque no haya reacción
      }

      // 💥 Soporte para touch y mouse
      let pressTimer;

      // 🖱️ Desktop
      bubble.addEventListener("mousedown", (e) => {
        if (e.target !== bubble) return;
        pressTimer = setTimeout(() => showReactionMenu(msg, doc.id, reactionBar, e), 500);
      });
      bubble.addEventListener("mouseup", () => clearTimeout(pressTimer));
      bubble.addEventListener("mouseleave", () => clearTimeout(pressTimer));
      bubble.addEventListener("dblclick", (e) => {
        if (e.target !== bubble) return;
        showReactionMenu(msg, doc.id, reactionBar, e);
      });

      // 📱 Móvil
      bubble.addEventListener("touchstart", (e) => {
        if (e.target !== bubble) return;
        e.preventDefault();
        pressTimer = setTimeout(
          () => showReactionMenu(msg, doc.id, reactionBar, e.touches[0]),
          500
        );
      });
      bubble.addEventListener("touchend", () => clearTimeout(pressTimer));
      bubble.addEventListener("touchcancel", () => clearTimeout(pressTimer));

      // 🧩 Orden correcto
      bubbleWrapper.appendChild(bubble);         // 💬 Mensaje
      bubbleWrapper.appendChild(reactionBar);    // 😄 Reacción debajo del mensaje
      bubbleWrapper.appendChild(time);           // 🕒 Hora

      if (isMine) {
        messageWrapper.appendChild(bubbleWrapper);
      } else {
        const avatar = document.createElement("img");
        avatar.src = msg.senderPhoto || "https://via.placeholder.com/32";
        avatar.className = "w-6 h-6 rounded-full mr-2 border";
        messageWrapper.appendChild(avatar);
        messageWrapper.appendChild(bubbleWrapper);
      }

      container.appendChild(messageWrapper);
    });

    container.scrollTop = container.scrollHeight;
  });
}









window.sendSimpleMessage = async function () {
  const input = document.getElementById("simpleMessageInput");
  const text = input.value.trim();

  // Verificación más detallada
  if (!text) {
    console.log("No hay texto para enviar");
    return;
  }

  if (!activeSimpleChatUid || !activeReceiverUid) {
    console.error("Faltan UIDs activos:", {
      activeSimpleChatUid,
      activeReceiverUid
    });
    return;
  }

  const currentUid = auth.currentUser.uid;
  console.log("Intentando enviar mensaje:", {
    text,
    activeSimpleChatUid,
    activeReceiverUid,
    currentUid
  });

  try {
    const chatRef = doc(db, "chats", activeSimpleChatUid);
    const messageRef = collection(chatRef, "messages");

    // Actualización del chat
    await setDoc(chatRef, {
      users: [currentUid, activeReceiverUid],
      lastMessage: text,
      lastUpdated: serverTimestamp()
    }, { merge: true });

    // Añadir el mensaje
    await addDoc(messageRef, {
      text,
      senderId: currentUid,
      senderPhoto: auth.currentUser.photoURL || null,
      timestamp: serverTimestamp(),
      reactions: {} // Campo inicializado para reacciones
    });

    input.value = "";
    console.log("Mensaje enviado con éxito");
  } catch (error) {
    console.error("Error al enviar mensaje:", error);
  }
};







window.showReactionMenu = async function (msg, messageId, container, event) {
  // Validación básica
  if (!activeSimpleChatUid || !auth.currentUser?.uid) return;

  // Limpiar menús anteriores
  document.querySelectorAll('.emoji-menu').forEach(el => el.remove());

  // Crear menú
  const menu = document.createElement("div");
  menu.className = "emoji-menu";
  Object.assign(menu.style, {
    position: "fixed",
    zIndex: 10000,
    background: "white",
    padding: "8px",
    borderRadius: "12px",
    display: "flex",
    gap: "4px"
  });

  // Posicionamiento
  const x = event.clientX || event.touches?.[0]?.clientX;
  const y = event.clientY || event.touches?.[0]?.clientY;
  menu.style.left = `${Math.max(10, x - 120)}px`;
  menu.style.top = `${Math.max(10, y - 60)}px`;

  // Añadir emojis
  ["❤️", "😂", "👍", "🔥", "😮", "😢"].forEach(emoji => {
    const btn = document.createElement("button");
    btn.textContent = emoji;
    btn.onclick = async (e) => {
      e.stopPropagation();
      try {
        await updateDoc(doc(db, "chats", activeSimpleChatUid, "messages", messageId), {
          [`reactions.${auth.currentUser.uid}`]: emoji
        });
      } catch (error) {
        console.error("Error al guardar reacción:", error);
      }
      menu.remove();
    };
    menu.appendChild(btn);
  });

  document.body.appendChild(menu);

  // Cerrar al hacer clic fuera
  const closeMenu = (e) => !menu.contains(e.target) && menu.remove();
  document.addEventListener("click", closeMenu, { once: true });
};










if (!window.__MODULO_PUBLICACION_PRODUCTOS_ACTIVO) {
  window.__MODULO_PUBLICACION_PRODUCTOS_ACTIVO = true;

  document.addEventListener('DOMContentLoaded', function () {

    const venderBtn = document.getElementById('venderBtn');
    const sellerPostModal = document.getElementById('sellerPostModal');
    let activePostId = "";

    venderBtn.addEventListener('click', function () {
      sellerPostModal.classList.remove('hidden');
      sellerPostModal.classList.add('flex');
    });

    window.closeSellerPostModal = function () {
      sellerPostModal.classList.add('hidden');
      sellerPostModal.classList.remove('flex');
    };

    window.publicarProducto = async function () {
      const btn = document.getElementById("publicarProductoBtn");
      const btnText = btn?.querySelector(".btn-text");
      const spinner = btn?.querySelector(".spinner");

      if (btn) {
        btn.disabled = true;
        if (btnText) btnText.textContent = "Publicando...";
        if (spinner) spinner.classList.remove("hidden");
      }

      try {
        const titulo = document.getElementById('productTitle').value;
        const descripcion = document.getElementById('productDescription').value;
        const precio = document.getElementById('productPrice').value;
        const imagenFile = document.getElementById('productImage').files[0];

        if (!titulo || !descripcion || !precio || !imagenFile) {
          alert('Completa todos los campos.');
          return;
        }

        const auth = getAuth();
        const user = auth.currentUser;

        if (!user) {
          alert('Debes iniciar sesión primero.');
          return;
        }

        const db = getFirestore();
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        const profileData = userSnap.exists() ? userSnap.data() : {
          username: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40"
        };

        let mediaURL = "";
        let isVideo = imagenFile.type.startsWith('video/');
        const formData = new FormData();
        formData.append('file', imagenFile);
        formData.append('upload_preset', 'Tweetsocial');

        const uploadURL = isVideo
          ? "https://api.cloudinary.com/v1_1/dz70korgo/video/upload"
          : "https://api.cloudinary.com/v1_1/dz70korgo/image/upload";

        const response = await fetch(uploadURL, { method: "POST", body: formData });
        const data = await response.json();

        if (!data.secure_url) {
          alert("Error al subir a Cloudinary");
          return;
        }

        mediaURL = data.secure_url;

        await addDoc(collection(db, "posts"), {
          tipo: "venta",
          titulo,
          descripcion,
          precio,
          imagen: mediaURL,
          isVideo,
          username: profileData.username,
          photoURL: profileData.modalPhotoURL || profileData.photoURL,
          uid: user.uid,
          timestamp: serverTimestamp()
        });

        document.getElementById('productTitle').value = "";
        document.getElementById('productDescription').value = "";
        document.getElementById('productPrice').value = "";
        document.getElementById('productImage').value = "";

        closeSellerPostModal();
        alert("✅ Producto publicado exitosamente.");
      } catch (error) {
        console.error("❌ Error al publicar:", error);
        alert("Error al publicar. Revisa la consola.");
      } finally {
        if (btn) {
          btn.disabled = false;
          if (btnText) btnText.textContent = "Publicar";
          if (spinner) spinner.classList.add("hidden");
        }
      }
    };

    function listenForPosts() {
      const db = getFirestore();
      const postsContainer = document.getElementById("postsContainer");
      const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

      onSnapshot(q, (snapshot) => {
        postsContainer.innerHTML = "";
        snapshot.forEach((doc) => {
          const postData = doc.data();
          const postId = doc.id;
          postsContainer.insertAdjacentHTML('beforeend', renderPostHTML(postData, {}, postId));
        });
      }, (error) => {
        console.error("Error en snapshot:", error);
      });
    }

    listenForPosts();

    document.addEventListener('click', async function (e) {
      const clicked = e.target;

      // 📷 Modal multimedia
      if (clicked.classList.contains('media-clickable')) {
        const src = clicked.src;
        const isVideo = clicked.tagName.toLowerCase() === 'video';
        const mediaContainer = document.getElementById('mediaContainer');
        mediaContainer.innerHTML = isVideo
          ? `<video controls autoplay class="max-w-full max-h-screen rounded shadow"><source src="${src}" type="video/mp4"></video>`
          : `<img src="${src}" class="max-w-full max-h-screen rounded shadow" alt="Media">`;
        document.getElementById('mediaModal').classList.remove('hidden');
      }

      // 💬 Mostrar modal de comentarios
      if (clicked.classList.contains('show-comments-btn')) {
        activePostId = clicked.getAttribute('data-post-id');
        document.getElementById('commentsModal').classList.remove('hidden');
        document.getElementById('commentsModal').classList.add('flex');
        loadModalComments(activePostId);
      }

      // 📩 Enviar comentario
      if (clicked.id === 'modalSendCommentBtn') {
        const input = document.getElementById('modalCommentInput');
        const text = input.value.trim();

        if (!text) return alert("Escribe un comentario");

        const auth = getAuth();
        const user = auth.currentUser;
        if (!user) return alert("Debes iniciar sesión");

        const db = getFirestore();
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);
        const profile = userSnap.exists() ? userSnap.data() : {
          username: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40"
        };

        await addDoc(collection(db, "posts", activePostId, "comentarios"), {
          text,
          uid: user.uid,
          username: profile.username,
          photoURL: profile.photoURL,
          timestamp: serverTimestamp()
        });

        input.value = "";
      }
    });

    window.closeMediaModal = function () {
      document.getElementById('mediaModal').classList.add('hidden');
      document.getElementById('mediaContainer').innerHTML = "";
    };

    window.closeCommentsModal = function () {
      document.getElementById('commentsModal').classList.add('hidden');
      document.getElementById('commentsModal').classList.remove('flex');
      document.getElementById('commentsModalContent').innerHTML = "";
      activePostId = "";
    };

    function loadModalComments(postId) {
      const db = getFirestore();
      const container = document.getElementById('commentsModalContent');
      const q = query(collection(db, "posts", postId, "comentarios"), orderBy("timestamp", "asc"));

      onSnapshot(q, (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach((doc) => {
          const c = doc.data();
          container.insertAdjacentHTML('beforeend', `
            <div class="flex items-start space-x-2 my-2">
              <img src="${c.photoURL}" class="w-8 h-8 rounded-full mt-1" alt="user">
              <div class="bg-gray-100 rounded-lg p-2">
                <span class="font-semibold text-sm text-blue-600">@${c.username}</span>
                <p class="text-gray-800 text-sm">${c.text}</p>
              </div>
            </div>
          `);
        });
      });
    }

  });
}





























// Script para el sidebar deslizable mejorado
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggleSidebar');
        const mainContent = document.getElementById('mainContent');
        let isCollapsed = false;

        toggleBtn.addEventListener('click', () => {
            isCollapsed = !isCollapsed;
            
            if(isCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
                toggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                `;
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                toggleBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                `;
            }
        });

        // (El resto de tus scripts aquí)












</script>
</body>
</html>
